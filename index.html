<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新興救護義消出勤系統</title>

  <!-- ✅ PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="新興救護出勤">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="./style.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <!-- ✅ 讀取 Spinner（置中） -->
  <div class="loadingOverlay" id="pageLoading" aria-hidden="true">
    <div class="w-100 h-100 d-flex align-items-center justify-content-center">
      <div class="box text-center">
        <div class="spinner-border" role="status" aria-label="loading"></div>
        <div class="mt-2 fw-semibold">讀取中...</div>
        <div class="small text-muted">請稍候</div>
      </div>
    </div>
  </div>

  <!-- 第一區 Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- ✅ 左：icon + 標題粗體靠左 -->
      <span class="navbar-brand fw-bold mb-0">
        <i class="fa-solid fa-fire-flame-curved me-2"></i>新興救護義消出勤系統
      </span>

      <!-- ✅ 右：單位 / 職稱 / 姓名 + 切換姓名（全部靠右） -->
      <div class="d-flex align-items-center gap-2 ms-auto">
        <span class="text-white-50 small d-flex align-items-center">
          <i class="fa-solid fa-building-flag me-1"></i><span id="navUnit">--</span>
        </span>
        <span class="text-white-50 small">
          <i class="fa-solid fa-id-badge me-1"></i><span id="navTitle">--</span>
        </span>
        <span class="text-white small fw-semibold">
          <i class="fa-solid fa-user me-1"></i><span id="navPersonName">--</span>
        </span>
        <button class="btn btn-sm btn-outline-light" id="btnSwitchPerson" type="button">
          <i class="fa-solid fa-repeat me-1"></i>切換姓名
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-3">

    <!-- 第二區 時間框 -->
    <div class="timeBox mb-3">
      <div class="dateLine" id="nowDateText">----</div>
      <div class="timeLine" id="nowClockText">--:--:--</div>
    </div>

    <!-- 第三區 定位 -->
    <div class="card roundedX mb-3">
      <div class="card-body">
        <div class="mb-2">
          <span class="badge text-bg-secondary badgeRound" id="gpsBadge">
            <i class="fa-solid fa-location-dot me-1"></i>尚未定位
          </span>
        </div>

        <div class="mono mb-1" id="gpsRawText">使用者定位：lat=--, lng=--</div>

        <!-- ✅ 由 JS 動態渲染：會依 dutyType 顯示 assist / training 的所有目標點 + 距離 -->
        <div class="small text-muted mb-3" id="gpsTargetText"></div>

        <button class="btn btn-primary w-100" id="btnRelocate" type="button">
          <i class="fa-solid fa-crosshairs me-1"></i>重新定位
        </button>
      </div>
    </div>

    <!-- 第四區 狀態區（全域：名單/定位/清單載入等） -->
    <div id="statusBar" class="mb-3"></div>

    <!-- 第五區 按鈕區 -->
    <div class="card roundedX mb-3">
      <div class="card-body">
        <button class="btn btn-lg btn-success w-100 mb-2" id="btnOpenSignIn" type="button">
          <i class="fa-solid fa-right-to-bracket me-2"></i>簽到
        </button>

        <button class="btn btn-lg btn-warning w-100" id="btnOpenSignOut" type="button">
          <i class="fa-solid fa-right-from-bracket me-2"></i>簽退
        </button>
      </div>
    </div>

    <!-- 第六區 出勤紀錄 -->
    <div class="card roundedX">
      <div class="card-body">

        <!-- ✅ 累積協勤時數（左右兩塊） -->
        <div class="row g-2 mb-3">
          <div class="col-12 col-md-6">
            <div class="hoursBox h-100">
              <div class="label">
                <i class="fa-solid fa-hourglass-half me-1"></i>總協勤時數
              </div>
              <div class="d-flex align-items-end">
                <div class="value" id="totalAssistHoursText">--</div>
                <div class="unit">小時</div>
              </div>
              <div class="small text-muted mt-1" id="totalAssistHint">--</div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="hoursBox h-100">
              <div class="label">
                <i class="fa-solid fa-calendar-days me-1"></i>本月協勤時數
              </div>
              <div class="d-flex align-items-end">
                <div class="value" id="monthAssistHoursText">--</div>
                <div class="unit">小時</div>
              </div>
              <div class="small text-muted mt-1" id="monthAssistHint">--</div>
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <div class="fw-bold">
            <i class="fa-solid fa-clipboard-list me-2"></i>出勤紀錄
            <span class="text-muted fw-normal" id="signYmText">----</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <input type="month" class="form-control form-control-sm" id="signYmPicker" style="max-width:160px;">
            <button class="btn btn-sm btn-outline-primary" id="btnRefreshSign" type="button">
              <i class="fa-solid fa-rotate me-1"></i>更新
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="white-space:nowrap;">勤務類型</th>
                <th style="white-space:nowrap;">簽到日期</th>
                <th style="white-space:nowrap;">簽到時間</th>
                <th style="white-space:nowrap;">簽退日期</th>
                <th style="white-space:nowrap;">簽退時間</th>
                <th style="white-space:nowrap;" class="text-end">時數(小時)</th>
              </tr>
            </thead>
            <tbody id="signTbody">
              <tr><td colspan="6" class="text-center text-muted py-3">載入中...</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

  <!-- 1) 開啟頁面先選人 Modal（✅ 顯示單位 + 職稱 + 姓名） -->
  <div class="modal fade" id="pickPersonModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-user-check me-2"></i>選擇使用者
          </h5>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">單位</label>
            <input class="form-control" id="pickUnit" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
          </div>

          <div class="mb-3">
            <label class="form-label">職稱</label>
            <input class="form-control" id="pickTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
          </div>

          <div class="mb-2">
            <label class="form-label">姓名</label>
            <select class="form-select" id="pickPersonName"></select>
          </div>

          <div class="small text-muted">選擇後下次自動帶入。</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" id="btnPickCancel" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-primary" id="btnPickOk" type="button">
            <i class="fa-solid fa-check me-1"></i>確定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) 簽到 Modal（✅ 不顯示單位，只顯示職稱/姓名） -->
  <div class="modal fade" id="signInModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-right-to-bracket me-2"></i>簽到
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>

        <div class="modal-body">
          <div id="inStatusBar" class="mb-3"></div>

          <div class="mb-3">
            <span class="badge text-bg-secondary badgeRound" id="inGpsBadge">
              <i class="fa-solid fa-location-dot me-1"></i>GPS 尚未判斷
            </span>
          </div>

          <div class="mb-3">
            <label class="form-label">勤務類別</label>
            <select class="form-select" id="inDutyType">
              <option value="assist">協勤</option>
              <option value="training">常年訓練</option>
              <option value="work">公差勤務</option>
            </select>
            <div class="form-text">
              協勤/常年訓練：需要通過 GPS；公差勤務：不需 GPS。
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">職稱</label>
              <input class="form-control" id="inTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
            </div>
            <div class="col-6">
              <label class="form-label">姓名</label>
              <select class="form-select" id="inPersonName"></select>
            </div>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">簽到日期</label>
              <input class="form-control" id="inDate" type="date">
            </div>
            <div class="col-6">
              <label class="form-label">簽到時間</label>
              <input class="form-control" id="inTime" type="time" step="60">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-success" id="btnSubmitSignIn" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>送出
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) 簽退 Modal（✅ 不顯示單位，只顯示職稱/姓名） -->
  <div class="modal fade" id="signOutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-right-from-bracket me-2"></i>簽退
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>

        <div class="modal-body">
          <div id="outStatusBar" class="mb-3"></div>

          <div class="mb-3">
            <span class="badge text-bg-secondary badgeRound" id="outGpsBadge">
              <i class="fa-solid fa-location-dot me-1"></i>GPS 尚未判斷
            </span>
          </div>

          <div class="mb-3">
            <label class="form-label">勤務類別</label>
            <select class="form-select" id="outDutyType">
              <option value="assist">協勤</option>
              <option value="work">公差勤務</option>
            </select>
            <div class="form-text">
              協勤：需要通過 GPS後選擇「出勤/備勤」；公差勤務：不需 GPS。
            </div>
          </div>

          <div class="mb-3" id="outModeWrap" style="display:none;">
            <label class="form-label">狀態</label>
            <select class="form-select" id="outMode">
              <option value="dispatch">出勤</option>
              <option value="standby">備勤</option>
            </select>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">職稱</label>
              <input class="form-control" id="outTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
            </div>
            <div class="col-6">
              <label class="form-label">姓名</label>
              <select class="form-select" id="outPersonName"></select>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">簽退日期</label>
              <input class="form-control" id="outDate" type="date">
            </div>
            <div class="col-6">
              <label class="form-label">簽退時間</label>
              <input class="form-control" id="outTime" type="time" step="60">
            </div>
          </div>

          <div class="mb-3" id="outContentWrap" style="display:none;">
            <label class="form-label">工作內容</label>
            <textarea class="form-control" id="outContent" rows="2" placeholder="例如：參加幹部會議 或 0800車禍高雄市新興區文化路29號"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-warning" id="btnSubmitSignOut" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>送出
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ 4) 送出確認 Modal（簽到/簽退共用；✅ 不顯示單位） -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-circle-question me-2"></i>確認送出
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning roundedX py-2 px-3">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>請確認資料無誤後再送出
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <tbody>
                <tr>
                  <th style="white-space:nowrap;width:110px;">類型</th>
                  <td id="cfType">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">職稱</th>
                  <td id="cfTitle">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">姓名</th>
                  <td id="cfPersonName">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">日期</th>
                  <td id="cfDate">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">時間</th>
                  <td id="cfTime">--</td>
                </tr>
                <tr id="cfContentRow" style="display:none;">
                  <th style="white-space:nowrap;">內容</th>
                  <td id="cfContent">--</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-primary" id="btnConfirmSubmit" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>確定送出
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="./script.js"></script>
</body>
</html>
