<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新興救護義消分隊出勤系統</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="出勤系統">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- Bootstrap 5.3.x -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome 6.5.x -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- jQuery 3.7.x + Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background:#fff; }
    .timeBox {
      background:#000;
      color:#fff;
      border-radius: .75rem;
      padding: 1rem 1.25rem;
      text-align:center;
    }
    .timeDate { font-size: 1.15rem; font-weight: 700; letter-spacing: .5px; }
    .timeClock { font-size: 2.6rem; font-weight: 900; letter-spacing: 1px; line-height: 1.05; }
    .smallMuted { color: #6c757d; font-size: .9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .confirmLine { display:flex; align-items:flex-start; gap:.5rem; margin:.25rem 0; }
    .confirmKey { width: 6.5rem; flex: 0 0 auto; color:#6c757d; }
    .confirmVal { flex: 1 1 auto; word-break: break-word; }

    .chip {
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.25rem .5rem;
      border-radius:999px;
      font-size:.85rem;
      border:1px solid rgba(255,255,255,.15);
      user-select:none;
    }
    .chipOk { background: rgba(25,135,84,.15); color:#d1ffe6; }
    .chipOff { background: rgba(108,117,125,.2); color:#f1f3f5; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2 fw-bold" href="#">
        <i class="fa-solid fa-id-card-clip"></i>
        <span>新興救護義消分隊出勤系統</span>
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="chip chipOff" id="notifyChip" role="button" tabindex="0" title="點一下可重新檢查通知狀態">
          <i class="fa-solid fa-bell"></i>
          <span id="notifyChipText">通知未開啟</span>
        </span>
      </div>
    </div>
  </nav>

  <main class="container py-4" style="max-width: 780px;">

    <!-- 第一區塊：日期/時間 -->
    <div class="timeBox mb-3">
      <div class="timeDate" id="nowDate">----</div>
      <div class="timeClock mono" id="nowTime">--:--:--</div>
    </div>

    <!-- 第二區塊：目前定位 -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-start gap-2">
          <div class="pt-1">
            <i class="fa-solid fa-location-dot"></i>
          </div>
          <div class="flex-grow-1">
            <div class="fw-bold">目前定位</div>
            <div class="smallMuted" id="locationText">尚未取得定位</div>
            <div class="smallMuted mono" id="locationLatLng"></div>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnGetLocation">
              <i class="fa-solid fa-crosshairs me-1"></i> 重新定位
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 第三區塊：表單/模式/按鈕 -->
    <div class="card">
      <div class="card-body">

        <!-- 勤務類型 -->
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="fa-solid fa-list-check me-1"></i> 勤務類型
          </label>
          <select class="form-select" id="dutyTypeSelect">
            <option value="standby">備勤（簽到/簽退，需比對定位）</option>
            <option value="training">常訓（簽到，需比對定位，多個定位）</option>
            <option value="work">公差勤務（簽到/簽退，不比對定位）</option>
          </select>
          <div class="smallMuted mt-1">
            <i class="fa-solid fa-map-location-dot me-1"></i>
            備勤/常訓會比對定位；公差勤務不比對定位。
          </div>
        </div>

        <!-- 職稱（下拉） -->
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="fa-solid fa-user-tie me-1"></i> 職稱
          </label>
          <select class="form-select" id="titleSelect">
            <option value="">請選擇職稱</option>
            <option value="分隊長">分隊長</option>
            <option value="副分隊長">副分隊長</option>
            <option value="小隊長">小隊長</option>
            <option value="幹事">幹事</option>
            <option value="隊員">隊員</option>
            <option value="見習">見習</option>
            <option value="其他">其他</option>
          </select>
          <div class="smallMuted mt-1">
            <i class="fa-solid fa-floppy-disk me-1"></i> 將自動暫存於本機
          </div>
        </div>

        <!-- 姓名 -->
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="fa-solid fa-user me-1"></i> 姓名
          </label>
          <input type="text" class="form-control" id="nameInput" placeholder="請輸入姓名">
          <div class="smallMuted mt-1">
            <i class="fa-solid fa-floppy-disk me-1"></i> 將自動暫存於本機
          </div>
        </div>

        <!-- 打卡時間模式 -->
        <div class="mb-3">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-bold">
              <i class="fa-solid fa-clock me-1"></i> 打卡時間
            </div>

            <div class="btn-group" role="group" aria-label="time mode">
              <input type="radio" class="btn-check" name="timeMode" id="timeModeNow" autocomplete="off" checked>
              <label class="btn btn-outline-dark" for="timeModeNow">
                <i class="fa-solid fa-bolt me-1"></i> 用現在時間
              </label>

              <input type="radio" class="btn-check" name="timeMode" id="timeModeManual" autocomplete="off">
              <label class="btn btn-outline-dark" for="timeModeManual">
                <i class="fa-solid fa-pen-to-square me-1"></i> 輸入時間
              </label>
            </div>
          </div>

          <div class="row g-2 mt-2" id="manualTimeRow" style="display:none;">
            <div class="col-12 col-md-6">
              <label class="form-label smallMuted mb-1">日期</label>
              <input type="date" class="form-control" id="manualDateInput">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label smallMuted mb-1">時間</label>
              <input type="time" step="1" class="form-control" id="manualTimeInput">
            </div>
            <div class="col-12">
              <div class="smallMuted">
                <i class="fa-solid fa-circle-info me-1"></i>
                輸入時間模式下，簽到/簽退將使用你指定的日期時間。
              </div>
            </div>
          </div>

          <div class="smallMuted mt-2">
            <span class="fw-bold">預覽：</span>
            <span class="mono" id="effectiveTimePreview">----</span>
          </div>
        </div>

        <!-- 未完成事項提示 -->
        <div class="alert alert-warning mb-3" id="pendingAlert" style="display:none;">
          <div class="fw-bold mb-1">
            <i class="fa-solid fa-triangle-exclamation me-1"></i> 尚有未完成事項
          </div>
          <div id="pendingText"></div>
          <div class="smallMuted mt-2">
            <i class="fa-solid fa-bell me-1"></i> 若通知已開啟，將於本次開啟頁面提醒一次
          </div>
        </div>

        <!-- 按鈕 -->
        <div class="d-grid d-md-flex gap-2">
          <button type="button" class="btn btn-success flex-fill" id="btnCheckIn">
            <i class="fa-solid fa-right-to-bracket me-1"></i> 簽到
          </button>
          <button type="button" class="btn btn-danger flex-fill" id="btnCheckOut">
            <i class="fa-solid fa-right-from-bracket me-1"></i> 簽退
          </button>
        </div>

        <!-- 結果提示 -->
        <div class="mt-3" id="resultArea" style="display:none;">
          <div class="alert mb-0" id="resultAlert">
            <div class="fw-bold mb-1">
              <i class="fa-solid fa-circle-check me-1"></i> 已送出（UI 預覽）
            </div>
            <div id="resultText"></div>
          </div>
        </div>

      </div>
    </div>

  </main>

  <!-- 送出確認視窗 -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title fw-bold">
            <i class="fa-solid fa-circle-question me-1"></i> 確認送出
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="smallMuted mb-2">請確認以下資料無誤後送出：</div>

          <div class="confirmLine">
            <div class="confirmKey">勤務</div>
            <div class="confirmVal fw-bold" id="confirmDutyText">-</div>
          </div>

          <div class="confirmLine">
            <div class="confirmKey">動作</div>
            <div class="confirmVal fw-bold" id="confirmActionText">-</div>
          </div>

          <div class="confirmLine">
            <div class="confirmKey">職稱</div>
            <div class="confirmVal" id="confirmTitleText">-</div>
          </div>

          <div class="confirmLine">
            <div class="confirmKey">姓名</div>
            <div class="confirmVal" id="confirmNameText">-</div>
          </div>

          <div class="confirmLine">
            <div class="confirmKey">時間</div>
            <div class="confirmVal mono" id="confirmTimeText">-</div>
          </div>

          <div class="confirmLine">
            <div class="confirmKey">定位</div>
            <div class="confirmVal mono" id="confirmLocationText">-</div>
          </div>

          <!-- 簽退勤務內容（備勤/公差勤務 才需要） -->
          <div id="checkoutNoteWrap" class="mt-3" style="display:none;">
            <label class="form-label fw-bold">
              <i class="fa-solid fa-pen me-1"></i> 勤務內容（簽退必填）
            </label>
            <textarea class="form-control" id="checkoutNoteInput" rows="3" placeholder="請簡短描述本次勤務內容…"></textarea>
            <div class="smallMuted mt-1">
              <i class="fa-solid fa-circle-info me-1"></i> 備勤/公差勤務簽退時必填
            </div>
          </div>

          <div class="smallMuted mt-3">
            <i class="fa-solid fa-triangle-exclamation me-1"></i>
            送出後將寫入系統（目前為 UI 範本預覽）。
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark me-1"></i> 取消
          </button>
          <button type="button" class="btn btn-primary" id="btnConfirmSubmit">
            <i class="fa-solid fa-paper-plane me-1"></i> 確認送出
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- 通知提示視窗（依 cooldown 提醒） -->
  <div class="modal fade" id="notifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title fw-bold">
            <i class="fa-solid fa-bell me-1"></i> 開啟手機通知
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-2">為了提醒你「未完成事項」（例如：已簽到尚未簽退），建議開啟通知。</div>
          <div class="smallMuted">
            <i class="fa-solid fa-circle-info me-1"></i>
            點「開啟」後會跳出系統通知權限詢問（需使用者手勢）。
          </div>
          <div class="smallMuted mt-2">
            <i class="fa-solid fa-mobile-screen-button me-1"></i>
            iOS 建議「加入主畫面」後使用，通知支援較完整。
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            稍後再說
          </button>
          <button type="button" class="btn btn-primary" id="btnEnableNotify">
            <i class="fa-solid fa-check me-1"></i> 開啟
          </button>
        </div>

      </div>
    </div>
  </div>

<script>
  (function () {
    "use strict";

    // -----------------------------
    // 你之後可改成從後端/Sheet 讀取
    // -----------------------------
    var geoConfig = {
      allowedRadiusMeters: 120, // 比對半徑
      standbyPoint: { latitude: 22.000000, longitude: 120.000000, name: "備勤定位" }, // 只會一個定位
      trainingPoints: [
        { latitude: 22.000000, longitude: 120.000000, name: "常訓定位A" },
        { latitude: 22.000500, longitude: 120.000500, name: "常訓定位B" }
      ]
    };

    // 通知提示頻率：控制「你自己的提醒視窗」多久跳一次（不是瀏覽器系統權限提示）
    var notifyConfig = {
      promptCooldownMinutes: 720 // 12 小時提醒一次
    };

    var timerId = null;
    var lastPosition = null;

    var confirmModal = null;
    var notifyModal = null;

    var pendingAction = null;     // "checkIn" | "checkOut"
    var pendingPayload = null;

    var storageKeys = {
      title: "dutySystem.basic.title",
      name: "dutySystem.basic.name",
      pendingState: "dutySystem.pending.state", // JSON
      notifyLastPromptAt: "dutySystem.notify.lastPromptAt"
    };

    function pad2(num) { return String(num).padStart(2, "0"); }

    function formatDateYmd(dt) {
      return dt.getFullYear() + "-" + pad2(dt.getMonth() + 1) + "-" + pad2(dt.getDate());
    }

    function formatTimeHms(dt) {
      return pad2(dt.getHours()) + ":" + pad2(dt.getMinutes()) + ":" + pad2(dt.getSeconds());
    }

    function safeSetLocalStorage(key, value) {
      try { localStorage.setItem(key, value); } catch (e) { }
    }

    function safeGetLocalStorage(key) {
      try { return localStorage.getItem(key); } catch (e) { return null; }
    }

    function safeSetJson(key, obj) {
      try { localStorage.setItem(key, JSON.stringify(obj)); } catch (e) { }
    }

    function safeGetJson(key) {
      try {
        var s = localStorage.getItem(key);
        if (!s) return null;
        return JSON.parse(s);
      } catch (e) {
        return null;
      }
    }

    // -----------------------------
    // PWA - Service Worker
    // -----------------------------
    function registerServiceWorker() {
      if (!("serviceWorker" in navigator)) return;
      navigator.serviceWorker.register("./service-worker.js").then(function () {
        // ok
      }).catch(function () {
        // ignore
      });
    }

    // -----------------------------
    // 時鐘
    // -----------------------------
    function updateNowClock() {
      var now = new Date();
      $("#nowDate").text(formatDateYmd(now));
      $("#nowTime").text(formatTimeHms(now));
      updateEffectiveTimePreview();
    }

    function isManualMode() {
      return $("#timeModeManual").is(":checked");
    }

    function getEffectiveDateTime() {
      if (!isManualMode()) return new Date();

      var manualDate = $("#manualDateInput").val();
      var manualTime = $("#manualTimeInput").val();
      if (!manualDate || !manualTime) return null;

      var timeParts = manualTime.split(":");
      var hh = parseInt(timeParts[0] || "0", 10);
      var mm = parseInt(timeParts[1] || "0", 10);
      var ss = parseInt(timeParts[2] || "0", 10);

      var dateParts = manualDate.split("-");
      var yyyy = parseInt(dateParts[0] || "1970", 10);
      var mon = parseInt(dateParts[1] || "1", 10) - 1;
      var dd = parseInt(dateParts[2] || "1", 10);

      return new Date(yyyy, mon, dd, hh, mm, ss);
    }

    function updateEffectiveTimePreview() {
      var dt = getEffectiveDateTime();
      if (!dt) {
        $("#effectiveTimePreview").text("（請輸入日期與時間）");
        return;
      }
      $("#effectiveTimePreview").text(formatDateYmd(dt) + " " + formatTimeHms(dt));
    }

    function setManualInputsToNow() {
      var now = new Date();
      $("#manualDateInput").val(formatDateYmd(now));
      $("#manualTimeInput").val(formatTimeHms(now));
    }

    // -----------------------------
    // 定位（兩段式：高精度 -> 降精度重試）
    // -----------------------------
    function setLocationStatus(text, latLngText) {
      $("#locationText").text(text || "");
      $("#locationLatLng").text(latLngText || "");
    }

    function geoErrorMessage(err) {
      if (!err) return "定位失敗";
      if (err.code === 1) return "定位失敗：未允許定位權限（請到瀏覽器/系統設定允許）";
      if (err.code === 2) return "定位失敗：無法取得位置（室內/訊號弱，建議移到戶外再試）";
      if (err.code === 3) return "定位失敗：逾時（Timeout expired，請稍後重試或移到戶外）";
      return "定位失敗：" + (err.message || "");
    }

    function getLocationOnce(options, onOk, onFail) {
      navigator.geolocation.getCurrentPosition(onOk, onFail, options);
    }

    function getLocation() {
      if (!navigator.geolocation) {
        setLocationStatus("此瀏覽器不支援定位功能", "");
        return;
      }

      setLocationStatus("定位中…", "");

      var opt1 = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
      var opt2 = { enableHighAccuracy: false, timeout: 20000, maximumAge: 0 };

      getLocationOnce(opt1, function (pos) {
        lastPosition = pos;
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;
        var acc = pos.coords.accuracy;
        setLocationStatus("定位成功（精度約 " + Math.round(acc) + " m）", "lat=" + lat + ", lng=" + lng);
      }, function (err1) {
        setLocationStatus(geoErrorMessage(err1) + "（改用一般精度重試…）", "");
        getLocationOnce(opt2, function (pos2) {
          lastPosition = pos2;
          var lat2 = pos2.coords.latitude;
          var lng2 = pos2.coords.longitude;
          var acc2 = pos2.coords.accuracy;
          setLocationStatus("定位成功（精度約 " + Math.round(acc2) + " m）", "lat=" + lat2 + ", lng=" + lng2);
        }, function (err2) {
          lastPosition = null;
          setLocationStatus(geoErrorMessage(err2), "");
        });
      });
    }

    // -----------------------------
    // 基本資料 localStorage
    // -----------------------------
    function loadBasicProfile() {
      var savedTitle = safeGetLocalStorage(storageKeys.title);
      var savedName = safeGetLocalStorage(storageKeys.name);
      if (savedTitle) $("#titleSelect").val(savedTitle);
      if (savedName) $("#nameInput").val(savedName);
    }

    function bindBasicProfileStorage() {
      $("#titleSelect").on("change", function () {
        safeSetLocalStorage(storageKeys.title, $("#titleSelect").val() || "");
      });
      $("#nameInput").on("input", function () {
        safeSetLocalStorage(storageKeys.name, ($("#nameInput").val() || "").trim());
      });
    }

    // -----------------------------
    // 勤務規則
    // -----------------------------
    function dutyType() {
      return $("#dutyTypeSelect").val() || "standby";
    }

    function dutyText(duty) {
      if (duty === "standby") return "備勤";
      if (duty === "training") return "常訓";
      if (duty === "work") return "公差勤務";
      return duty || "-";
    }

    function actionText(action) {
      if (action === "checkIn") return "簽到";
      if (action === "checkOut") return "簽退";
      return action || "-";
    }

    function needsGeoCheck(duty) {
      return duty !== "work"; // 備勤/常訓要比對
    }

    function supportsCheckout(duty) {
      return duty !== "training"; // 常訓只有簽到
    }

    function needsCheckoutNote(duty, action) {
      return (action === "checkOut") && (duty === "standby" || duty === "work");
    }

    function buildLocationDisplayFromPayload(payload) {
      if (!payload || !payload.location) return "（未取得定位）";
      return "lat=" + payload.location.latitude + ", lng=" + payload.location.longitude + "（±" + Math.round(payload.location.accuracy) + "m）";
    }

    function toRadians(deg) { return deg * Math.PI / 180; }

    function distanceMeters(lat1, lon1, lat2, lon2) {
      var R = 6371000;
      var dLat = toRadians(lat2 - lat1);
      var dLon = toRadians(lon2 - lon1);
      var a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function checkGeoAllowed(duty) {
      if (!needsGeoCheck(duty)) return { ok: true, message: "" };

      if (!lastPosition || !lastPosition.coords) {
        return { ok: false, message: "需要定位才能打卡，請先取得定位" };
      }

      var lat = lastPosition.coords.latitude;
      var lng = lastPosition.coords.longitude;
      var radius = geoConfig.allowedRadiusMeters || 100;

      if (duty === "standby") {
        var p = geoConfig.standbyPoint;
        var d = distanceMeters(lat, lng, p.latitude, p.longitude);
        if (d <= radius) return { ok: true, message: "" };
        return { ok: false, message: "不在備勤指定範圍內（距離約 " + Math.round(d) + " m）" };
      }

      if (duty === "training") {
        var list = geoConfig.trainingPoints || [];
        if (!list.length) return { ok: false, message: "常訓定位未設定" };

        var best = null;
        for (var i = 0; i < list.length; i++) {
          var pi = list[i];
          var di = distanceMeters(lat, lng, pi.latitude, pi.longitude);
          if (best === null || di < best.distance) {
            best = { distance: di, name: pi.name || ("定位" + (i + 1)) };
          }
        }

        if (best && best.distance <= radius) return { ok: true, message: "" };
        return { ok: false, message: "不在常訓指定範圍內（最近點 " + (best ? best.name : "") + " 距離約 " + Math.round(best.distance) + " m）" };
      }

      return { ok: true, message: "" };
    }

    function applyDutyRulesUi() {
      var duty = dutyType();
      if (!supportsCheckout(duty)) $("#btnCheckOut").hide();
      else $("#btnCheckOut").show();
    }

    // -----------------------------
    // 表單驗證 / Payload
    // -----------------------------
    function validateForm(action) {
      var duty = dutyType();
      var title = ($("#titleSelect").val() || "").trim();
      var name = ($("#nameInput").val() || "").trim();

      if (!duty) return { ok: false, message: "請選擇勤務類型" };
      if (!title) return { ok: false, message: "請選擇職稱" };
      if (!name) return { ok: false, message: "請輸入姓名" };

      if (!supportsCheckout(duty) && action === "checkOut") {
        return { ok: false, message: "常訓只需要簽到，不需要簽退" };
      }

      if (isManualMode()) {
        var dt = getEffectiveDateTime();
        if (!dt) return { ok: false, message: "請輸入打卡日期與時間" };
      }

      var geoCheck = checkGeoAllowed(duty);
      if (!geoCheck.ok) return geoCheck;

      return { ok: true, message: "" };
    }

    function buildPunchPayload(action) {
      var duty = dutyType();
      var title = ($("#titleSelect").val() || "").trim();
      var name = ($("#nameInput").val() || "").trim();
      var dt = getEffectiveDateTime();

      var payload = {
        duty: duty,
        action: action,
        title: title,
        name: name,
        punchDate: dt ? formatDateYmd(dt) : null,
        punchTime: dt ? formatTimeHms(dt) : null,
        punchIso: dt ? dt.toISOString() : null,
        timeMode: isManualMode() ? "manual" : "now",
        location: null,
        note: null
      };

      if (lastPosition && lastPosition.coords) {
        payload.location = {
          latitude: lastPosition.coords.latitude,
          longitude: lastPosition.coords.longitude,
          accuracy: lastPosition.coords.accuracy
        };
      }

      return payload;
    }

    // -----------------------------
    // UI 結果呈現（不顯示 JSON）
    // -----------------------------
    function showResultSuccess(payload) {
      $("#resultArea").show();
      $("#resultAlert").removeClass("alert-danger alert-info").addClass("alert-success");

      var lines = [];
      lines.push("勤務：" + dutyText(payload.duty));
      lines.push("動作：" + actionText(payload.action));
      lines.push("職稱：" + (payload.title || "-"));
      lines.push("姓名：" + (payload.name || "-"));
      lines.push("時間：" + (payload.punchDate || "-") + " " + (payload.punchTime || "-"));
      lines.push("定位：" + buildLocationDisplayFromPayload(payload));
      if (payload.note) lines.push("勤務內容：" + payload.note);

      $("#resultText").html("<div>" + lines.map(function (s) {
        return $("<div/>").text(s).html();
      }).join("</div><div>") + "</div>");
    }

    function showResultError(message) {
      $("#resultArea").show();
      $("#resultAlert").removeClass("alert-success alert-info").addClass("alert-danger");
      $("#resultText").text(message || "發生錯誤");
    }

    // -----------------------------
    // 未完成事務（簽到未簽退）
    // -----------------------------
    function getPendingState() {
      return safeGetJson(storageKeys.pendingState);
    }

    function setPendingState(state) {
      if (!state) {
        try { localStorage.removeItem(storageKeys.pendingState); } catch (e) { }
        return;
      }
      safeSetJson(storageKeys.pendingState, state);
    }

    function updatePendingUi() {
      var s = getPendingState();
      if (!s || !s.isCheckedIn) {
        $("#pendingAlert").hide();
        return;
      }

      var text = "你已簽到尚未簽退：" +
        dutyText(s.duty) + " / " + (s.title || "-") + " " + (s.name || "-") +
        "（" + (s.punchDate || "-") + " " + (s.punchTime || "-") + "）";

      $("#pendingText").text(text);
      $("#pendingAlert").show();
    }

    // -----------------------------
    // 通知（以 SW showNotification 優先）
    // -----------------------------
    function isNotificationSupported() {
      return ("Notification" in window);
    }

    function getNotificationPermission() {
      if (!isNotificationSupported()) return "unsupported";
      return Notification.permission; // "default" | "granted" | "denied"
    }

    function updateNotifyChip() {
      var perm = getNotificationPermission();
      var enabled = (perm === "granted");

      if (enabled) {
        $("#notifyChip").removeClass("chipOff").addClass("chipOk");
        $("#notifyChipText").text("通知已開啟");
      } else {
        $("#notifyChip").removeClass("chipOk").addClass("chipOff");
        $("#notifyChipText").text("通知未開啟");
      }
    }

    function shouldShowNotifyPrompt() {
      if (!isNotificationSupported()) return false;
      if (Notification.permission === "granted") return false;

      var last = parseInt(safeGetLocalStorage(storageKeys.notifyLastPromptAt) || "0", 10);
      var now = Date.now();
      var cooldownMs = (notifyConfig.promptCooldownMinutes || 720) * 60 * 1000;

      if (!last) return true;
      return (now - last) >= cooldownMs;
    }

    function markNotifyPromptShown() {
      safeSetLocalStorage(storageKeys.notifyLastPromptAt, String(Date.now()));
    }

    function showLocalNotification(title, body) {
      if (!isNotificationSupported()) return;
      if (Notification.permission !== "granted") return;

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistration().then(function (reg) {
          if (reg && reg.showNotification) {
            reg.showNotification(title, { body: body || "" });
          } else {
            new Notification(title, { body: body || "" });
          }
        });
        return;
      }

      new Notification(title, { body: body || "" });
    }

    function notifyPendingIfAny(force) {
      // 本次頁面只通知一次，避免洗版
      var sessionKey = "dutySystem.pending.notifiedThisSession";
      var already = null;
      try { already = sessionStorage.getItem(sessionKey); } catch (e) { }

      if (!force && already === "1") return;

      var s = getPendingState();
      if (!s || !s.isCheckedIn) return;

      var title = "尚有未完成事項";
      var body = "你已簽到尚未簽退：" + dutyText(s.duty) + " / " + (s.name || "-") +
        "（" + (s.punchDate || "-") + " " + (s.punchTime || "-") + "）";

      showLocalNotification(title, body);
      try { sessionStorage.setItem(sessionKey, "1"); } catch (e) { }
    }

    function askEnableNotifyIfNeeded() {
      updateNotifyChip();
      if (!isNotificationSupported()) return;
      if (Notification.permission === "granted") return;

      // cooldown 控制你的提醒視窗頻率
      if (shouldShowNotifyPrompt()) {
        markNotifyPromptShown();
        notifyModal.show();
      }
    }

    function requestEnableNotify() {
      if (!isNotificationSupported()) {
        showResultError("此瀏覽器不支援通知功能");
        return;
      }

      Notification.requestPermission().then(function (perm) {
        updateNotifyChip();

        if (perm === "granted") {
          // 開啟後：若有未完成事項就通知一次
          notifyPendingIfAny(true);
          notifyModal.hide();
        } else if (perm === "denied") {
          showResultError("通知已被封鎖，請到瀏覽器/系統設定中允許通知");
          notifyModal.hide();
        } else {
          // default
          notifyModal.hide();
        }
      }).catch(function () {
        showResultError("無法請求通知權限");
      });
    }

    // -----------------------------
    // 送出確認
    // -----------------------------
    function showConfirmModal(action, payload) {
      pendingAction = action;
      pendingPayload = payload;

      $("#confirmDutyText").text(dutyText(payload.duty));
      $("#confirmActionText").text(actionText(action));
      $("#confirmTitleText").text(payload.title || "-");
      $("#confirmNameText").text(payload.name || "-");
      $("#confirmTimeText").text((payload.punchDate || "-") + " " + (payload.punchTime || "-"));
      $("#confirmLocationText").text(buildLocationDisplayFromPayload(payload));

      if (needsCheckoutNote(payload.duty, action)) {
        $("#checkoutNoteWrap").show();
        $("#checkoutNoteInput").val("");
      } else {
        $("#checkoutNoteWrap").hide();
        $("#checkoutNoteInput").val("");
      }

      confirmModal.show();
    }

    function validateConfirmNoteIfNeeded() {
      if (!pendingPayload) return { ok: false, message: "無送出資料" };

      if (needsCheckoutNote(pendingPayload.duty, pendingPayload.action)) {
        var note = ($("#checkoutNoteInput").val() || "").trim();
        if (!note) return { ok: false, message: "簽退需填寫勤務內容" };
      }

      return { ok: true, message: "" };
    }

    function submitPunch(payload) {
      // TODO: 串接後端/Google Sheet 時，把這裡換成 $.ajax(...)

      if (payload.action === "checkIn") {
        if (supportsCheckout(payload.duty)) {
          setPendingState({
            isCheckedIn: true,
            duty: payload.duty,
            title: payload.title,
            name: payload.name,
            punchDate: payload.punchDate,
            punchTime: payload.punchTime
          });
        } else {
          setPendingState(null);
        }
      }

      if (payload.action === "checkOut") {
        setPendingState(null);
      }

      showResultSuccess(payload);
      updatePendingUi();
      notifyPendingIfAny(false);
    }

    function onPunch(action) {
      var v = validateForm(action);
      if (!v.ok) {
        showResultError(v.message);
        return;
      }

      var payload = buildPunchPayload(action);
      showConfirmModal(action, payload);
    }

    // -----------------------------
    // UI 綁定
    // -----------------------------
    function bindEvents() {
      $("#btnGetLocation").on("click", function () { getLocation(); });

      $("#timeModeNow").on("change", function () {
        $("#manualTimeRow").hide();
        updateEffectiveTimePreview();
      });

      $("#timeModeManual").on("change", function () {
        $("#manualTimeRow").show();
        setManualInputsToNow();
        updateEffectiveTimePreview();
      });

      $("#manualDateInput, #manualTimeInput").on("input change", function () {
        updateEffectiveTimePreview();
      });

      $("#dutyTypeSelect").on("change", function () {
        applyDutyRulesUi();
      });

      $("#btnCheckIn").on("click", function () { onPunch("checkIn"); });
      $("#btnCheckOut").on("click", function () { onPunch("checkOut"); });

      $("#btnConfirmSubmit").on("click", function () {
        if (!pendingPayload) return;

        var v = validateConfirmNoteIfNeeded();
        if (!v.ok) {
          showResultError(v.message);
          return;
        }

        if (needsCheckoutNote(pendingPayload.duty, pendingPayload.action)) {
          pendingPayload.note = ($("#checkoutNoteInput").val() || "").trim();
        }

        confirmModal.hide();
        submitPunch(pendingPayload);
      });

      $("#confirmModal").on("hidden.bs.modal", function () {
        pendingAction = null;
        pendingPayload = null;
        $("#checkoutNoteInput").val("");
      });

      // 通知
      $("#btnEnableNotify").on("click", function () {
        requestEnableNotify();
      });

      $("#notifyChip").on("click keydown", function (e) {
        if (e.type === "keydown" && e.key !== "Enter" && e.key !== " ") return;
        updateNotifyChip();
        if (getNotificationPermission() !== "granted") {
          // 允許手動點 chip 再提醒一次（不走 cooldown）
          notifyModal.show();
        } else {
          // 已開啟：手動測試一次（確認橫幅是否會跳）
          showLocalNotification("通知測試", "通知已開啟，可用於提醒未完成事項");
        }
      });

      // 基本資料暫存
      $("#titleSelect").on("change", function () {
        safeSetLocalStorage(storageKeys.title, $("#titleSelect").val() || "");
      });

      $("#nameInput").on("input", function () {
        safeSetLocalStorage(storageKeys.name, ($("#nameInput").val() || "").trim());
      });
    }

    function initModals() {
      confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"), {
        backdrop: "static",
        keyboard: false
      });

      notifyModal = new bootstrap.Modal(document.getElementById("notifyModal"), {
        backdrop: "static",
        keyboard: true
      });
    }

    function init() {
      registerServiceWorker();

      initModals();
      loadBasicProfile();
      bindBasicProfileStorage();
      bindEvents();

      applyDutyRulesUi();

      updateNowClock();
      timerId = window.setInterval(updateNowClock, 1000);

      getLocation();

      updateNotifyChip();
      askEnableNotifyIfNeeded();

      updatePendingUi();
      notifyPendingIfAny(false);
    }

    $(document).ready(init);

  })();
</script>

</body>
</html>
