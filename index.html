<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新興救護義消出勤系統</title>

  <!-- ✅ PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="義消出勤">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background:#f6f7f9; }

    .timeBox{
      background:#000; color:#fff; border-radius:16px;
      padding:12px 12px; text-align:center;
    }
    .timeBox .dateLine{ font-size:18px; font-weight:700; opacity:.92; line-height:1.2; }
    .timeBox .timeLine{ font-size:40px; font-weight:900; line-height:1.1; margin-top:2px; letter-spacing:1px; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .roundedX { border-radius:16px; }
    .badgeRound { border-radius:999px; padding:.5rem .75rem; }

    /* ✅ 置中讀取遮罩 */
    .loadingOverlay{
      position:fixed; inset:0; z-index:2000;
      display:none;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(0.5px);
    }
    .loadingOverlay .box{
      background:#fff; border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding:18px 20px;
      min-width: 220px;
    }
  </style>
</head>

<body>

  <!-- ✅ 讀取 Spinner（置中） -->
  <div class="loadingOverlay" id="pageLoading" aria-hidden="true">
    <div class="w-100 h-100 d-flex align-items-center justify-content-center">
      <div class="box text-center">
        <div class="spinner-border" role="status" aria-label="loading"></div>
        <div class="mt-2 fw-semibold">讀取中...</div>
        <div class="small text-muted">請稍候</div>
      </div>
    </div>
  </div>

  <!-- 第一區 Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">
        <i class="fa-solid fa-fire-flame-curved me-2"></i>新興救護義消出勤系統
      </span>

      <div class="d-flex align-items-center gap-2">
        <span class="text-white-50 small">
          <i class="fa-solid fa-id-badge me-1"></i><span id="navUnitTitle">--</span>
        </span>
        <span class="text-white small fw-semibold">
          <i class="fa-solid fa-user me-1"></i><span id="navPersonName">--</span>
        </span>
        <button class="btn btn-sm btn-outline-light" id="btnSwitchPerson" type="button">
          <i class="fa-solid fa-repeat me-1"></i>切換姓名
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-3">

    <!-- 第二區 時間框 -->
    <div class="timeBox mb-3">
      <div class="dateLine" id="nowDateText">----</div>
      <div class="timeLine" id="nowClockText">--:--:--</div>
    </div>

    <!-- 第三區 定位 -->
    <div class="card roundedX mb-3">
      <div class="card-body">
        <div class="mb-2">
          <span class="badge text-bg-secondary badgeRound" id="gpsBadge">
            <i class="fa-solid fa-location-dot me-1"></i>尚未定位
          </span>
        </div>

        <div class="mono mb-1" id="gpsRawText">使用者定位：lat=--, lng=--</div>
        <div class="small text-muted mb-3" id="gpsTargetText">
          新興分隊： lat=22.630760865622978, lng=120.31122281518338 ／ 半徑：100 m
        </div>

        <button class="btn btn-primary w-100" id="btnRelocate" type="button">
          <i class="fa-solid fa-crosshairs me-1"></i>重新定位
        </button>
      </div>
    </div>

    <!-- 第四區 狀態區（全域：名單/定位/清單載入等） -->
    <div id="statusBar" class="mb-3"></div>

    <!-- 第五區 按鈕區 -->
    <div class="card roundedX mb-3">
      <div class="card-body">
        <button class="btn btn-success w-100 mb-2" id="btnOpenSignIn" type="button">
          <i class="fa-solid fa-right-to-bracket me-2"></i>簽到
        </button>
        <button class="btn btn-warning w-100" id="btnOpenSignOut" type="button">
          <i class="fa-solid fa-right-from-bracket me-2"></i>簽退
        </button>
      </div>
    </div>

    <!-- 第六區 出勤紀錄 -->
    <div class="card roundedX">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <div class="fw-bold">
            <i class="fa-solid fa-clipboard-list me-2"></i>出勤紀錄
            <span class="text-muted fw-normal" id="signYmText">----</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <input type="month" class="form-control form-control-sm" id="signYmPicker" style="max-width:160px;">
            <button class="btn btn-sm btn-outline-primary" id="btnRefreshSign" type="button">
              <i class="fa-solid fa-rotate me-1"></i>更新
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="white-space:nowrap;">勤務類型</th>
                <th style="white-space:nowrap;">簽到日期</th>
                <th style="white-space:nowrap;">簽到時間</th>
                <th style="white-space:nowrap;">簽退日期</th>
                <th style="white-space:nowrap;">簽退時間</th>
              </tr>
            </thead>
            <tbody id="signTbody">
              <tr><td colspan="5" class="text-center text-muted py-3">載入中...</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

  <!-- 1) 開啟頁面先選人 Modal -->
  <div class="modal fade" id="pickPersonModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-user-check me-2"></i>選擇使用者
          </h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">職稱</label>
            <input class="form-control" id="pickUnitTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
          </div>
          <div class="mb-2">
            <label class="form-label">姓名</label>
            <select class="form-select" id="pickPersonName"></select>
          </div>
          <div class="small text-muted">選擇後會儲存在 Local Storage，下次自動帶入。</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" id="btnPickCancel" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-primary" id="btnPickOk" type="button">
            <i class="fa-solid fa-check me-1"></i>確定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) 簽到 Modal -->
  <div class="modal fade" id="signInModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-right-to-bracket me-2"></i>簽到
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>

        <div class="modal-body">
          <!-- ✅ 簽到提示列（專用） -->
          <div id="inStatusBar" class="mb-3"></div>

          <div class="mb-3">
            <span class="badge text-bg-secondary badgeRound" id="inGpsBadge">
              <i class="fa-solid fa-location-dot me-1"></i>GPS 尚未判斷
            </span>
          </div>

          <div class="mb-3">
            <label class="form-label">勤務類別</label>
            <select class="form-select" id="inDutyType">
              <option value="assist">協勤</option>
              <option value="training">常年訓練</option>
              <option value="work">公差勤務</option>
            </select>
            <div class="form-text">
              協勤／常年訓練：需要通過 GPS；公差勤務：不需 GPS。
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">職稱</label>
              <input class="form-control" id="inUnitTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
            </div>
            <div class="col-6">
              <label class="form-label">姓名</label>
              <select class="form-select" id="inPersonName"></select>
            </div>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">簽到日期</label>
              <input class="form-control" id="inDate" type="date">
            </div>
            <div class="col-6">
              <label class="form-label">簽到時間</label>
              <input class="form-control" id="inTime" type="time" step="60">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-success" id="btnSubmitSignIn" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>送出
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) 簽退 Modal -->
  <div class="modal fade" id="signOutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-right-from-bracket me-2"></i>簽退
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>

        <div class="modal-body">
          <!-- ✅ 簽退提示列（專用） -->
          <div id="outStatusBar" class="mb-3"></div>

          <div class="mb-3">
            <span class="badge text-bg-secondary badgeRound" id="outGpsBadge">
              <i class="fa-solid fa-location-dot me-1"></i>GPS 尚未判斷
            </span>
          </div>

          <div class="mb-3">
            <label class="form-label">勤務類別</label>
            <select class="form-select" id="outDutyType">
              <option value="assist">協勤</option>
              <option value="work">公差勤務</option>
            </select>
            <div class="form-text">
              協勤：需要通過 GPS，並可選「備勤／出勤」；公差勤務：不需 GPS（需填工作內容）。
            </div>
          </div>

          <div class="mb-3" id="outModeWrap" style="display:none;">
            <label class="form-label">狀態</label>
            <select class="form-select" id="outMode">
              <option value="standby">備勤</option>
              <option value="dispatch">出勤</option>
            </select>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">職稱</label>
              <input class="form-control" id="outUnitTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
            </div>
            <div class="col-6">
              <label class="form-label">姓名</label>
              <select class="form-select" id="outPersonName"></select>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">簽退日期</label>
              <input class="form-control" id="outDate" type="date">
            </div>
            <div class="col-6">
              <label class="form-label">簽退時間</label>
              <input class="form-control" id="outTime" type="time" step="60">
            </div>
          </div>

          <div class="mb-3" id="outContentWrap" style="display:none;">
            <label class="form-label">工作內容</label>
            <textarea class="form-control" id="outContent" rows="2" placeholder="例如：參加幹部會議 或 0800車禍三民區吉林街142號"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-warning" id="btnSubmitSignOut" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>送出
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  const webAppUrl = "https://script.google.com/macros/s/AKfycbzft0lPlbdTRdLZTgVHOB4A16xGUAFqYpZjbenWuvw-qoiKvNaTAhsTCuKHhZ3N7lWa/exec";

  const gpsRules = {
    assist: [
      { name: "新興分隊", lat: 22.630760865622978, lng: 120.31122281518338, radius: 100 }
    ],
    training: [
      { name: "新興分隊", lat: 22.630760865622978, lng: 120.31122281518338, radius: 100 },
      { name: "日月光K11", lat: 22.722363004033074, lng: 120.30469365772642, radius: 100 }
    ]
  };

  const LS_KEY = "xh_ems_person_v1"; // { unitTitle, personName }
  let people = [];
  let selected = { unitTitle: "", personName: "" };
  let lastGps = { ok:false, lat:null, lng:null, accuracy:null };

  let pickModal, inModal, outModal;

  $(function(){
    pickModal = new bootstrap.Modal(document.getElementById("pickPersonModal"));
    inModal = new bootstrap.Modal(document.getElementById("signInModal"));
    outModal = new bootstrap.Modal(document.getElementById("signOutModal"));

    registerServiceWorker_();
    startClock_();
    bindEvents_();

    // ✅ 進頁先顯示置中 spinner（讀名單/讀清單時都顯示）
    showLoading_(true);

    loadPeople_().then(function(){
      loadSelectedFromStorage_();

      if (!isSelectedValid_()) {
        openPickModal_();
      } else {
        applySelectedToUi_();
      }

      setDefaultMonth_();

      // ✅ 讀清單時也顯示置中 spinner
      return refreshSignAsync_();
    }).always(function(){
      showLoading_(false);

      // 預先定位一次（不阻塞 spinner）
      locate_();
    });
  });

  function bindEvents_(){
    $("#btnRelocate").on("click", locate_);

    $("#btnSwitchPerson").on("click", function(){
      openPickModal_();
    });

    $("#pickPersonName").on("change", function(){
      const name = $(this).val();
      setUnitTitleByName_(name, "#pickUnitTitle");
    });

    // ✅ 簽到：改姓名 -> 職稱跟著變
    $("#inPersonName").on("change", function(){
      const name = $(this).val();
      setUnitTitleByName_(name, "#inUnitTitle");
    });

    // ✅ 簽退：改姓名 -> 職稱跟著變
    $("#outPersonName").on("change", function(){
      const name = $(this).val();
      setUnitTitleByName_(name, "#outUnitTitle");
    });

    $("#btnPickCancel").on("click", function(){
      if (!isSelectedValid_()) return;
      pickModal.hide();
    });

    $("#btnPickOk").on("click", function(){
      const name = $("#pickPersonName").val();
      const p = findPersonByName_(name);
      if (!p) { showStatus_("danger", "請先選擇姓名"); return; }

      selected.unitTitle = p.unitTitle || "";
      selected.personName = p.personName || "";
      saveSelectedToStorage_();
      applySelectedToUi_();
      pickModal.hide();

      showLoading_(true);
      refreshSignAsync_().always(function(){ showLoading_(false); });
    });

    $("#btnOpenSignIn").on("click", function(){
      clearSignStatus_("in");
      fillSignInModal_();
      updateGpsBadgeForModal_("in");
      inModal.show();
    });

    $("#btnOpenSignOut").on("click", function(){
      clearSignStatus_("out");
      fillSignOutModal_();
      updateOutUiByDuty_();
      updateGpsBadgeForModal_("out");
      outModal.show();
    });

    $("#inDutyType").on("change", function(){
      updateGpsBadgeForModal_("in");
    });

    $("#outDutyType").on("change", function(){
      updateOutUiByDuty_();
      updateGpsBadgeForModal_("out");
    });

    $("#outMode").on("change", function(){
      updateOutUiByDuty_();
    });

    $("#btnSubmitSignIn").on("click", submitSignIn_);
    $("#btnSubmitSignOut").on("click", submitSignOut_);

    $("#btnRefreshSign").on("click", function(){
      showLoading_(true);
      refreshSignAsync_().always(function(){ showLoading_(false); });
    });

    $("#signYmPicker").on("change", function(){
      showLoading_(true);
      refreshSignAsync_().always(function(){ showLoading_(false); });
    });
  }

  // ✅ 置中 spinner 顯示/隱藏
  function showLoading_(show){
    if (show) $("#pageLoading").show();
    else $("#pageLoading").hide();
  }

  // ✅ 工具：依姓名找人
  function findPersonByName_(name){
    const n = String(name || "").trim();
    if (!n) return null;
    return people.find(x => x && x.personName === n) || null;
  }

  // ✅ 工具：依姓名回填職稱到指定 input
  function setUnitTitleByName_(name, unitTitleSelector){
    const p = findPersonByName_(name);
    $(unitTitleSelector).val(p ? (p.unitTitle || "") : "");
  }

  // ---------- UI: clock ----------
  function startClock_(){
    tick_();
    setInterval(tick_, 1000);
  }

  function tick_(){
    const now = new Date();
    $("#nowDateText").text(fmtDate_(now));
    $("#nowClockText").text(fmtClockHms_(now));
  }

  // ---------- People / selected ----------
  function loadPeople_(){
    showStatus_("info", "載入名單中...");
    return $.get(webAppUrl, { action:"people" })
      .then(function(res){
        if (!res || !res.ok) throw new Error((res && res.message) ? res.message : "名單載入失敗");
        people = res.data || [];
        if (!people.length) showStatus_("warning", "people 無資料");
        else showStatus_("success", "名單載入完成");

        buildPeopleSelects_();
      })
      .catch(function(err){
        showStatus_("danger", "名單載入失敗：" + (err && err.message ? err.message : err));
      });
  }

  function buildPeopleSelects_(){
    const opts = [];
    for (let i=0;i<people.length;i++){
      const p = people[i];
      opts.push(`<option value="${esc_(p.personName)}">${esc_(p.personName)}</option>`);
    }
    const html = opts.join("") || `<option value="">無資料</option>`;

    $("#pickPersonName").html(html);
    $("#inPersonName").html(html);
    $("#outPersonName").html(html);
  }

  function loadSelectedFromStorage_(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      selected.unitTitle = String(obj.unitTitle || "");
      selected.personName = String(obj.personName || "");
    } catch { }
  }

  function saveSelectedToStorage_(){
    try {
      localStorage.setItem(LS_KEY, JSON.stringify({
        unitTitle: selected.unitTitle || "",
        personName: selected.personName || ""
      }));
    } catch { }
  }

  function isSelectedValid_(){
    if (!selected.personName) return false;
    return people.some(p => p.personName === selected.personName);
  }

  function applySelectedToUi_(){
    $("#navUnitTitle").text(selected.unitTitle || "--");
    $("#navPersonName").text(selected.personName || "--");
  }

  function openPickModal_(){
    if (isSelectedValid_()){
      $("#pickPersonName").val(selected.personName);
      $("#pickUnitTitle").val(selected.unitTitle);
    } else {
      const first = people[0];
      $("#pickPersonName").val(first ? first.personName : "");
      $("#pickUnitTitle").val(first ? first.unitTitle : "");
    }
    pickModal.show();
  }

  // ---------- GPS ----------
  function locate_(){
    if (!("geolocation" in navigator)) {
      setGpsUi_("secondary", "不支援定位", null);
      showStatus_("danger", "此瀏覽器不支援定位功能");
      return;
    }

    setGpsUi_("secondary", "定位中...", null);

    navigator.geolocation.getCurrentPosition(
      function(pos){
        lastGps.ok = true;
        lastGps.lat = pos.coords.latitude;
        lastGps.lng = pos.coords.longitude;
        lastGps.accuracy = Math.round(pos.coords.accuracy || 0);

        $("#gpsRawText").text(`使用者定位：lat=${lastGps.lat}, lng=${lastGps.lng}`);
        setGpsUi_("success", "定位成功", `精度約 ${lastGps.accuracy} 公尺`);
        updateGpsBadgeForModal_("in");
        updateGpsBadgeForModal_("out");
      },
      function(err){
        lastGps.ok = false;
        lastGps.lat = null;
        lastGps.lng = null;
        lastGps.accuracy = null;

        $("#gpsRawText").text("使用者定位：lat=--, lng=--");
        setGpsUi_("danger", "定位失敗", (err && err.message) ? err.message : "定位失敗");
        showStatus_("danger", "定位失敗，請確認定位權限或 GPS 設定");
      },
      { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
    );
  }

  function setGpsUi_(bsType, text, info){
    $("#gpsBadge")
      .removeClass("text-bg-secondary text-bg-success text-bg-danger text-bg-warning")
      .addClass("text-bg-" + bsType)
      .html(`<i class="fa-solid fa-location-dot me-1"></i>${esc_(text)}`);

    if (info) showStatus_("info", info);
  }

  function needGps_(dutyType){
    return dutyType === "assist" || dutyType === "training";
  }

  function gpsPass_(dutyType){
    if (!needGps_(dutyType)) return { pass:true, msg:"不需比對 GPS" };
    if (!lastGps.ok) return { pass:false, msg:"尚未定位" };

    const rules = (dutyType === "training") ? gpsRules.training : gpsRules.assist;

    let passAny = false;
    for (let i=0;i<rules.length;i++){
      const t = rules[i];
      const d = Math.round(distMeters_(lastGps.lat, lastGps.lng, t.lat, t.lng));
      if (d <= (t.radius || 0)) passAny = true;
    }
    return { pass: passAny, msg: passAny ? "GPS 通過" : "GPS 未通過" };
  }

  function updateGpsBadgeForModal_(which){
    const duty = (which === "in") ? $("#inDutyType").val() : $("#outDutyType").val();
    const r = gpsPass_(duty);

    const $b = (which === "in") ? $("#inGpsBadge") : $("#outGpsBadge");
    $b.removeClass("text-bg-secondary text-bg-success text-bg-danger")
      .addClass("text-bg-" + (r.pass ? "success" : "danger"))
      .html(`<i class="fa-solid fa-location-dot me-1"></i>${esc_(r.msg)}`);
  }

  // ---------- Sign list ----------
  function setDefaultMonth_(){
    const now = new Date();
    const ym = fmtYearMonth_(now);
    $("#signYmPicker").val(ym);
    $("#signYmText").text(ym);
  }

  // ✅ 改成回傳 jqXHR（可用 .always()）
  function refreshSignAsync_(){
    const ym = $("#signYmPicker").val() || fmtYearMonth_(new Date());
    $("#signYmText").text(ym);

    $("#signTbody").html(`<tr><td colspan="5" class="text-center text-muted py-3">載入中...</td></tr>`);

    return $.get(webAppUrl, { action:"sign", ym: ym })
      .done(function(res){
        if (!res || !res.ok) {
          const msg = (res && res.message) ? res.message : "載入失敗";
          $("#signTbody").html(`<tr><td colspan="5" class="text-center text-danger py-3">${esc_(msg)}</td></tr>`);
          return;
        }

        const list = res.data || [];
        if (!list.length) {
          $("#signTbody").html(`<tr><td colspan="5" class="text-center text-muted py-3">無資料</td></tr>`);
          return;
        }

        const rows = [];
        for (let i=0;i<list.length;i++){
          const r = list[i];
          rows.push(`
            <tr>
              <td>${esc_(r.dutyTypeText || "")}</td>
              <td>${esc_(r.signInDate || "")}</td>
              <td>${esc_(toHm_(r.signInTime || ""))}</td>
              <td>${esc_(r.signOutDate || "")}</td>
              <td>${esc_(toHm_(r.signOutTime || ""))}</td>
            </tr>
          `);
        }
        $("#signTbody").html(rows.join(""));
      })
      .fail(function(){
        $("#signTbody").html(`<tr><td colspan="5" class="text-center text-danger py-3">載入失敗（請確認 GAS 部署/權限）</td></tr>`);
      });
  }

  // ---------- SignIn / SignOut ----------
  function fillSignInModal_(){
    const now = new Date();

    $("#inPersonName").val(selected.personName || "");
    setUnitTitleByName_($("#inPersonName").val(), "#inUnitTitle");

    $("#inDate").val(fmtDate_(now));
    $("#inTime").val(fmtClockHm_(now));

    if (!$("#inDutyType").val()) $("#inDutyType").val("assist");
  }

  function fillSignOutModal_(){
    const now = new Date();

    $("#outPersonName").val(selected.personName || "");
    setUnitTitleByName_($("#outPersonName").val(), "#outUnitTitle");

    $("#outDate").val(fmtDate_(now));
    $("#outTime").val(fmtClockHm_(now));

    if (!$("#outDutyType").val()) $("#outDutyType").val("assist");
  }

  function updateOutUiByDuty_(){
    const duty = $("#outDutyType").val();
    const mode = $("#outMode").val();

    if (duty === "assist") {
      $("#outModeWrap").show();
      $("#outContentWrap").toggle(mode === "dispatch");
      if (mode !== "dispatch") $("#outContent").val("");
      return;
    }

    $("#outModeWrap").hide();
    $("#outMode").val("standby");
    $("#outContentWrap").show();
  }

  function submitSignIn_(){
    clearSignStatus_("in");

    const dutyType = $("#inDutyType").val();
    const unitTitle = $("#inUnitTitle").val().trim();
    const personName = $("#inPersonName").val().trim();
    const signInDate = $("#inDate").val();
    const signInTime = toHm_($("#inTime").val());

    if (!personName) { showSignStatus_("in", "danger", "請選姓名"); return; }
    if (!signInDate || !signInTime) { showSignStatus_("in", "danger", "簽到日期／時間為必填"); return; }

    const gps = gpsPass_(dutyType);
    if (!gps.pass && needGps_(dutyType)) { showSignStatus_("in", "danger", "GPS 未通過，無法簽到"); return; }

    showSignStatus_("in", "info", "簽到送出中...");
    showLoading_(true);

    $.get(webAppUrl, {
      action:"signIn",
      dutyType: dutyType,
      unitTitle: unitTitle,
      personName: personName,
      signInDate: signInDate,
      signInTime: signInTime
    })
    .done(function(res){
      if (res && res.ok) {
        showSignStatus_("in", "success", "簽到完成");
        inModal.hide();
        refreshSignAsync_();
      } else {
        showSignStatus_("in", "danger", "簽到失敗：" + ((res && res.message) ? res.message : "原因不明"));
      }
    })
    .fail(function(){
      showSignStatus_("in", "danger", "簽到送出失敗（請確認 GAS 部署／權限）");
    })
    .always(function(){
      showLoading_(false);
    });
  }

  function submitSignOut_(){
    clearSignStatus_("out");

    const dutyType = $("#outDutyType").val();
    const unitTitle = $("#outUnitTitle").val().trim();
    const personName = $("#outPersonName").val().trim();
    const signOutDate = $("#outDate").val();
    const signOutTime = toHm_($("#outTime").val());
    const mode = $("#outMode").val();
    const content = $("#outContent").val().trim();

    if (!personName) { showSignStatus_("out", "danger", "請選姓名"); return; }
    if (!signOutDate || !signOutTime) { showSignStatus_("out", "danger", "簽退日期／時間為必填"); return; }

    const gps = gpsPass_(dutyType);
    if (!gps.pass && needGps_(dutyType)) { showSignStatus_("out", "danger", "GPS 未通過，無法簽退"); return; }

    let dutyContent = "";
    if (dutyType === "assist") {
      if (mode === "standby") {
        dutyContent = "備勤";
      } else {
        if (!content) { showSignStatus_("out", "danger", "協勤「出勤」請填工作內容"); return; }
        dutyContent = content;
      }
    } else {
      if (!content) { showSignStatus_("out", "danger", "公差勤務請填工作內容"); return; }
      dutyContent = content;
    }

    showSignStatus_("out", "info", "簽退送出中...");
    showLoading_(true);

    $.get(webAppUrl, {
      action:"signOut",
      dutyType: dutyType,
      unitTitle: unitTitle,
      personName: personName,
      signOutDate: signOutDate,
      signOutTime: signOutTime,
      dutyContent: dutyContent
    })
    .done(function(res){
      if (res && res.ok) {
        showSignStatus_("out", "success", "簽退完成");
        outModal.hide();
        refreshSignAsync_();
      } else {
        showSignStatus_("out", "danger", "簽退失敗：" + ((res && res.message) ? res.message : "原因不明"));
      }
    })
    .fail(function(){
      showSignStatus_("out", "danger", "簽退送出失敗（請確認 GAS 部署／權限）");
    })
    .always(function(){
      showLoading_(false);
    });
  }

  // ---------- status / utils ----------
  function showStatus_(type, msg){
    $("#statusBar").html(`
      <div class="alert alert-${esc_(type)} roundedX py-2 px-3 mb-0">
        <i class="fa-solid ${typeIcon_(type)} me-2"></i>${esc_(msg)}
      </div>
    `);
  }

  // ✅ 簽到/簽退專用提示列
  function clearSignStatus_(which){
    const $wrap = (which === "in") ? $("#inStatusBar") : $("#outStatusBar");
    $wrap.html("");
  }

  function showSignStatus_(which, type, msg){
    const $wrap = (which === "in") ? $("#inStatusBar") : $("#outStatusBar");
    $wrap.html(`
      <div class="alert alert-${esc_(type)} roundedX py-2 px-3 mb-0">
        <i class="fa-solid ${typeIcon_(type)} me-2"></i>${esc_(msg)}
      </div>
    `);
  }

  function typeIcon_(type){
    if (type === "success") return "fa-circle-check";
    if (type === "danger") return "fa-triangle-exclamation";
    if (type === "warning") return "fa-circle-exclamation";
    return "fa-circle-info";
  }

  function fmtDate_(d){
    const y = d.getFullYear();
    const m = pad2_(d.getMonth()+1);
    const day = pad2_(d.getDate());
    return `${y}-${m}-${day}`;
  }

  function fmtYearMonth_(d){
    const y = d.getFullYear();
    const m = pad2_(d.getMonth()+1);
    return `${y}-${m}`;
  }

  function fmtClockHms_(d){
    const hh = pad2_(d.getHours());
    const mm = pad2_(d.getMinutes());
    const ss = pad2_(d.getSeconds());
    return `${hh}:${mm}:${ss}`;
  }

  function fmtClockHm_(d){
    const hh = pad2_(d.getHours());
    const mm = pad2_(d.getMinutes());
    return `${hh}:${mm}`;
  }

  function toHm_(s){
    const t = String(s || "").trim();
    if (!t) return "";
    if (t.length >= 5) return t.substring(0, 5);
    return t;
  }

  function pad2_(n){ return (n<10 ? "0" : "") + n; }

  function esc_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function distMeters_(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);

    const a =
      Math.sin(dLat/2)*Math.sin(dLat/2) +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
      Math.sin(dLng/2)*Math.sin(dLng/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function registerServiceWorker_(){
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  }
</script>
</body>
</html>
