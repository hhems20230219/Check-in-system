<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>新興救護義消分隊打卡系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">

    <h3 class="text-center mb-4">
      <i class="fas fa-fire-extinguisher text-danger me-2"></i>
      高雄市義勇消防總隊第一救護大隊<br>新興分隊打卡系統
    </h3>

    <!-- 職稱下拉式選單 -->
    <div class="mb-3">
      <label for="position" class="form-label">
        <i class="fas fa-id-badge me-1"></i>職稱
      </label>
      <select id="position" class="form-select" required>
        <option value="" disabled selected>請選擇您的職稱</option>
        <option value="分隊長">分隊長</option>
        <option value="副分隊長">副分隊長</option>
        <option value="幹事">幹事</option>
        <option value="助理幹事">助理幹事</option>
        <option value="小隊長">小隊長</option>
        <option value="副小隊長">副小隊長</option>
        <option value="隊員">隊員</option>
      </select>
    </div>

    <!-- 姓名輸入 -->
    <div class="mb-3">
      <label for="name" class="form-label">
        <i class="fas fa-user me-1"></i>姓名
      </label>
      <input type="text" id="name" class="form-control" placeholder="請輸入您的姓名">
    </div>

    <!-- 查詢打卡紀錄 -->
    <div class="d-grid gap-2 mb-3">
      <button id="queryBtn" class="btn btn-warning btn-lg">
        <i class="fas fa-search me-1"></i>查詢本月打卡紀錄
      </button>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center my-3 d-none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
      </div>
      <div class="mt-2 text-primary">資料傳送中，請稍候...</div>
    </div>

    <!-- 結果 -->
    <div id="result" class="alert d-none" role="alert"></div>
    
    <!-- 查詢紀錄 Modal -->
    <div class="modal fade" id="recordModal" tabindex="-1" aria-labelledby="recordModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="recordModalLabel"><i class="fas fa-list me-2"></i>本月打卡紀錄</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th>職稱</th>
                    <th>姓名</th>
                    <th>起始時間</th>
                    <th>結束時間</th>
                    <th>協勤項目</th>
                    <th>小計 (分鐘)</th>
                  </tr>
                </thead>
                <tbody id="recordBodyModal"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 取得 GPS 按鈕 -->
    <div class="mb-3">
      <button id="getLocationBtn" class="btn btn-outline-secondary">
        <i class="fas fa-location-crosshairs me-1"></i>取得目前位置
      </button>
    </div>

    <!-- GPS 狀態 -->
    <div id="gpsStatus" class="text-muted mb-2">
      <i class="fas fa-satellite me-1"></i>尚未取得 GPS 座標
    </div>

    <!-- GPS 資訊顯示 -->
    <div id="locationInfo" class="mb-4">
      <p><i class="fas fa-globe-asia me-1"></i>經度：<span id="lng">--</span></p>
      <p><i class="fas fa-globe-asia me-1"></i>緯度：<span id="lat">--</span></p>
      <p><i class="fas fa-ruler-horizontal me-1"></i>與打卡地點距離：<span id="distance">--</span> 公尺</p>
    </div>

    <!-- 打卡按鈕 -->
    <div class="d-grid gap-2 mb-3">
      <button id="checkInBtn" class="btn btn-success btn-lg">
        <i class="fas fa-briefcase me-1"></i>協勤簽到/簽退
      </button>
      <button id="trainingBtn" class="btn btn-primary btn-lg">
        <i class="fas fa-dumbbell me-1"></i>常訓簽到/簽退
      </button>
    </div>
  </div>

<!-- ✅ 完整保留原功能，並修正後端 JSON 回應與前端簽退確認框，無其他改動 -->
<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwuCe68Y5ijgDrS-GXvHkg58nNFKdnjFHBvYwv97hk-hGweSkVepflV53eF34StNm2L/exec';

const targetLocations = [
  { lat: 22.644269524152527, lng: 120.30640604418643 },
  { lat: 22.630554822560363, lng: 120.31129486887772 }
];
const rangeMeters = 1000;

function toRadians(deg) { return deg * Math.PI / 180; }
function calculateDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = toRadians(lat2 - lat1);
  const dLng = toRadians(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRadians(lat1))*Math.cos(toRadians(lat2))*Math.sin(dLng/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function isWithinDistance(lat, lng) {
  return targetLocations.some(loc =>
    calculateDistance(lat, lng, loc.lat, loc.lng) <= rangeMeters);
}
function isTrainingTimeValid() {
  const now = new Date();
  const m = now.getHours()*60 + now.getMinutes();
  return m >= 1170 && m <= 1230; // 19:30–20:30
}
function updateLocationInfo(lat, lng) {
  let closest = Infinity;
  targetLocations.forEach(loc => {
    const d = calculateDistance(lat, lng, loc.lat, loc.lng);
    if (d < closest) closest = d;
  });
  $('#lat').text(lat.toFixed(6));
  $('#lng').text(lng.toFixed(6));
  $('#distance').text(Math.round(closest));
}
function showResult(ok, msg) {
  $('#result')
    .removeClass('d-none alert-success alert-danger')
    .addClass('alert ' + (ok ? 'alert-success' : 'alert-danger'))
    .text(msg);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function finishUI() {
  $('#checkInBtn, #trainingBtn').prop('disabled', false);
  $('#loadingSpinner').addClass('d-none');
}
async function submitPunch(name, position, type) {
  $('#checkInBtn, #trainingBtn').prop('disabled', true);
  $('#loadingSpinner').removeClass('d-none');
  showResult(true, '正在傳送打卡資料中...');
  $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>正在取得 GPS 座標…');

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    updateLocationInfo(lat, lng);
    $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>已取得座標');

    if (!isWithinDistance(lat, lng)) {
      showResult(false, '您不在指定範圍內');
      return finishUI();
    }
    if (type==='常訓' && !isTrainingTimeValid()) {
      showResult(false, '目前不在常訓時段');
      return finishUI();
    }

    $.get(GAS_URL, { name, type, position }, res => {
      let json;
      try {
        json = typeof res === 'string' ? JSON.parse(res) : res;
      } catch (e) {
        return showResult(false, '伺服器回傳格式錯誤'), finishUI();
      }

      if (json.status === 'signout') {
        if (!confirm('偵測到您為簽退，是否確認簽退？')) {
          return showResult(false, '已取消簽退操作'), finishUI();
        }
      }

      showResult(json.status !== 'error', json.message);
      finishUI();
    }).fail(() => {
      showResult(false, '伺服器連線失敗');
      finishUI();
    });
  }, () => {
    showResult(false, '無法取得 GPS');
    finishUI();
  });
}
</script>
