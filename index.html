<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>高雄市義勇消防總隊第一救護大隊新興分隊打卡系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">

    <h3 class="text-center mb-4">
      <i class="fas fa-fire-extinguisher text-danger me-2"></i>
      高雄市義勇消防總隊第一救護大隊新興分隊打卡系統
    </h3>

    <!-- 職稱下拉式選單 -->
    <div class="mb-3">
      <label for="position" class="form-label">
        <i class="fas fa-id-badge me-1"></i>職稱
      </label>
      <select id="position" class="form-select" required>
        <option value="" disabled selected>請選擇您的職稱</option>
        <option value="分隊長">分隊長</option>
        <option value="副分隊長">副分隊長</option>
        <option value="幹事">幹事</option>
        <option value="助理幹事">助理幹事</option>
        <option value="小隊長">小隊長</option>
        <option value="副小隊長">副小隊長</option>
        <option value="隊員">隊員</option>
      </select>
    </div>

    <!-- 姓名輸入 -->
    <div class="mb-3">
      <label for="name" class="form-label">
        <i class="fas fa-user me-1"></i>姓名
      </label>
      <input type="text" id="name" class="form-control" placeholder="請輸入您的姓名">
    </div>

    <!-- 取得 GPS 按鈕 -->
    <div class="mb-3">
      <button id="getLocationBtn" class="btn btn-outline-secondary">
        <i class="fas fa-location-crosshairs me-1"></i>取得目前位置
      </button>
    </div>

    <!-- GPS 狀態 -->
    <div id="gpsStatus" class="text-muted mb-2">
      <i class="fas fa-satellite me-1"></i>尚未取得 GPS 座標
    </div>

    <!-- GPS 資訊顯示 -->
    <div id="locationInfo" class="mb-4">
      <p><i class="fas fa-globe-asia me-1"></i>經度：<span id="lng">--</span></p>
      <p><i class="fas fa-globe-asia me-1"></i>緯度：<span id="lat">--</span></p>
      <p><i class="fas fa-ruler-horizontal me-1"></i>與打卡地點距離：<span id="distance">--</span> 公尺</p>
    </div>

    <!-- 打卡按鈕 -->
    <div class="d-grid gap-2 mb-3">
      <button id="checkInBtn" class="btn btn-success btn-lg">
        <i class="fas fa-briefcase me-1"></i>協勤簽到/簽退
      </button>
      <button id="trainingBtn" class="btn btn-primary btn-lg">
        <i class="fas fa-dumbbell me-1"></i>常訓簽到/簽退
      </button>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center my-3 d-none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
      </div>
      <div class="mt-2 text-primary">資料傳送中，請稍候...</div>
    </div>

    <!-- 打卡結果 -->
    <div id="result" class="alert d-none" role="alert"></div>
  </div>

<script>
  // 多個合法打卡座標
  const targetLocations = [
    { lat: 22.644269524152527, lng: 120.30640604418643 }, // 測試點
    { lat: 22.630554822560363, lng: 120.31129486887772 }  // 新興分隊
  ];
  const rangeMeters = 1000;

  function toRadians(deg) {
    return deg * Math.PI / 180;
  }

  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const dLat = toRadians(lat2 - lat1);
    const dLng = toRadians(lng2 - lng1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
              Math.sin(dLng / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function isWithinDistance(lat, lng) {
    return targetLocations.some(loc => calculateDistance(lat, lng, loc.lat, loc.lng) <= rangeMeters);
  }

  function isTrainingTimeValid() {
    const now = new Date();
    const minutes = now.getHours() * 60 + now.getMinutes();
    return minutes >= 1170 && minutes <= 1230; // 19:30–20:30
  }

  function updateLocationInfo(lat, lng) {
    let closestDistance = Infinity;
    targetLocations.forEach(loc => {
      const d = calculateDistance(lat, lng, loc.lat, loc.lng);
      if (d < closestDistance) closestDistance = d;
    });

    $('#lat').text(lat.toFixed(6));
    $('#lng').text(lng.toFixed(6));
    $('#distance').text(Math.round(closestDistance));
  }

  function showResult(success, message) {
    $('#result')
      .removeClass('d-none alert-success alert-danger')
      .addClass('alert ' + (success ? 'alert-success' : 'alert-danger'))
      .text(message);
  }

  function submitPunch(name, position, type) {
    $('#checkInBtn, #trainingBtn').prop('disabled', true);
    showResult(true, '正在傳送打卡資料中，請稍候...');
    $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>正在取得 GPS 座標...');

    navigator.geolocation.getCurrentPosition(positionData => {
      const lat = positionData.coords.latitude;
      const lng = positionData.coords.longitude;
      updateLocationInfo(lat, lng);
      $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>已成功取得座標');

      if (!isWithinDistance(lat, lng)) {
        showResult(false, '您不在指定打卡範圍內');
        $('#checkInBtn, #trainingBtn').prop('disabled', false);
        return;
      }

      if (type === '常訓' && !isTrainingTimeValid()) {
        showResult(false, '目前不在常訓打卡時段（19:30–20:30）');
        $('#checkInBtn, #trainingBtn').prop('disabled', false);
        return;
      }

      $.get(
        'https://script.google.com/macros/s/AKfycbwSzS68B7hXWT0Fgy8CuZoUbzrY44fVg4sgtEm0VkWD_TFqQ_WZaIPv1IhoVEr1VqM/exec',
        {
          name: name,
          type: type,
          position: position
        },
        (response) => {
          showResult(true, response);
          $('#checkInBtn, #trainingBtn').prop('disabled', false);
        }
      ).fail(() => {
        showResult(false, '無法連線至伺服器');
        $('#checkInBtn, #trainingBtn').prop('disabled', false);
      });

    }, () => {
      $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>無法取得 GPS 座標');
      showResult(false, '無法取得 GPS 位置');
      $('#checkInBtn, #trainingBtn').prop('disabled', false);
    });
  }

  $('#getLocationBtn').click(() => {
    $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>正在取得 GPS 座標...');
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      updateLocationInfo(lat, lng);
      $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>已成功取得座標');
    }, () => {
      $('#lat').text('無法取得');
      $('#lng').text('無法取得');
      $('#distance').text('--');
      $('#gpsStatus').html('<i class="fas fa-satellite me-1"></i>無法取得 GPS 座標');
    });
  });

  $('#checkInBtn').click(() => {
    const name = $('#name').val().trim();
    const position = $('#position').val().trim();
    if (!name) return showResult(false, '請輸入姓名');
    if (!position) return showResult(false, '請選擇職稱');
    submitPunch(name, position, '協勤');
  });

  $('#trainingBtn').click(() => {
    const name = $('#name').val().trim();
    const position = $('#position').val().trim();
    if (!name) return showResult(false, '請輸入姓名');
    if (!position) return showResult(false, '請選擇職稱');
    submitPunch(name, position, '常訓');
  });
</script>
</body>
</html>
