<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新興救護義消出勤系統</title>

  <!-- ✅ PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="新興救護出勤">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background:#f6f7f9; }

    .timeBox{
      background:#000; color:#fff; border-radius:16px;
      padding:12px 12px; text-align:center;
    }
    .timeBox .dateLine{ font-size:20px; font-weight:700; opacity:.92; line-height:1.2; }
    .timeBox .timeLine{ font-size:50px; font-weight:900; line-height:1.1; margin-top:2px; letter-spacing:1px; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .roundedX { border-radius:16px; }
    .badgeRound { border-radius:999px; padding:.5rem .75rem; }

    /* ✅ 置中讀取遮罩 */
    .loadingOverlay{
      position:fixed; inset:0; z-index:2000;
      display:none;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(0.5px);
    }
    .loadingOverlay .box{
      background:#fff; border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding:18px 20px;
      min-width: 220px;
    }

    .hoursBox{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:12px 14px;
    }
    .hoursBox .label{ color:#6c757d; font-size:12px; }
    .hoursBox .value{ font-size:28px; font-weight:900; line-height:1.1; }
    .hoursBox .unit{ font-size:12px; color:#6c757d; margin-left:6px; font-weight:700; }
  </style>
</head>

<body>

  <!-- ✅ 讀取 Spinner（置中） -->
  <div class="loadingOverlay" id="pageLoading" aria-hidden="true">
    <div class="w-100 h-100 d-flex align-items-center justify-content-center">
      <div class="box text-center">
        <div class="spinner-border" role="status" aria-label="loading"></div>
        <div class="mt-2 fw-semibold">讀取中...</div>
        <div class="small text-muted">請稍候</div>
      </div>
    </div>
  </div>

  <!-- 第一區 Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- ✅ 左：icon + 標題粗體靠左 -->
      <span class="navbar-brand fw-bold mb-0">
        <i class="fa-solid fa-fire-flame-curved me-2"></i>新興救護義消出勤系統
      </span>

      <!-- ✅ 右：單位 / 職稱 / 姓名 + 切換姓名（全部靠右） -->
      <div class="d-flex align-items-center gap-2 ms-auto">
        <span class="text-white-50 small d-flex align-items-center">
          <i class="fa-solid fa-building-flag me-1"></i><span id="navUnit">--</span>
        </span>
        <span class="text-white-50 small">
          <i class="fa-solid fa-id-badge me-1"></i><span id="navTitle">--</span>
        </span>
        <span class="text-white small fw-semibold">
          <i class="fa-solid fa-user me-1"></i><span id="navPersonName">--</span>
        </span>
        <button class="btn btn-sm btn-outline-light" id="btnSwitchPerson" type="button">
          <i class="fa-solid fa-repeat me-1"></i>切換姓名
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-3">

    <!-- 第二區 時間框 -->
    <div class="timeBox mb-3">
      <div class="dateLine" id="nowDateText">----</div>
      <div class="timeLine" id="nowClockText">--:--:--</div>
    </div>

    <!-- 第三區 定位 -->
    <div class="card roundedX mb-3">
      <div class="card-body">
        <div class="mb-2">
          <span class="badge text-bg-secondary badgeRound" id="gpsBadge">
            <i class="fa-solid fa-location-dot me-1"></i>尚未定位
          </span>
        </div>

        <div class="mono mb-1" id="gpsRawText">使用者定位：lat=--, lng=--</div>
        <div class="small text-muted mb-3" id="gpsTargetText">
          新興分隊： lat=22.630760865622978, lng=120.31122281518338 ／ 半徑：100 m
        </div>

        <button class="btn btn-primary w-100" id="btnRelocate" type="button">
          <i class="fa-solid fa-crosshairs me-1"></i>重新定位
        </button>
      </div>
    </div>

    <!-- 第四區 狀態區（全域：名單/定位/清單載入等） -->
    <div id="statusBar" class="mb-3"></div>

    <!-- 第五區 按鈕區 -->
    <div class="card roundedX mb-3">
      <div class="card-body">
        <button class="btn btn-lg btn-success w-100 mb-2" id="btnOpenSignIn" type="button">
          <i class="fa-solid fa-right-to-bracket me-2"></i>簽到
        </button>

        <button class="btn btn-lg btn-warning w-100" id="btnOpenSignOut" type="button">
          <i class="fa-solid fa-right-from-bracket me-2"></i>簽退
        </button>
      </div>
    </div>

    <!-- 第六區 出勤紀錄 -->
    <div class="card roundedX">
      <div class="card-body">

        <!-- ✅ 累積協勤時數（左右兩塊） -->
        <div class="row g-2 mb-3">
          <div class="col-12 col-md-6">
            <div class="hoursBox h-100">
              <div class="label">
                <i class="fa-solid fa-hourglass-half me-1"></i>總協勤時數
              </div>
              <div class="d-flex align-items-end">
                <div class="value" id="totalAssistHoursText">--</div>
                <div class="unit">小時</div>
              </div>
              <div class="small text-muted mt-1" id="totalAssistHint">--</div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="hoursBox h-100">
              <div class="label">
                <i class="fa-solid fa-calendar-days me-1"></i>本月協勤時數
              </div>
              <div class="d-flex align-items-end">
                <div class="value" id="monthAssistHoursText">--</div>
                <div class="unit">小時</div>
              </div>
              <div class="small text-muted mt-1" id="monthAssistHint">--</div>
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <div class="fw-bold">
            <i class="fa-solid fa-clipboard-list me-2"></i>出勤紀錄
            <span class="text-muted fw-normal" id="signYmText">----</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <input type="month" class="form-control form-control-sm" id="signYmPicker" style="max-width:160px;">
            <button class="btn btn-sm btn-outline-primary" id="btnRefreshSign" type="button">
              <i class="fa-solid fa-rotate me-1"></i>更新
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="white-space:nowrap;">勤務類型</th>
                <th style="white-space:nowrap;">簽到日期</th>
                <th style="white-space:nowrap;">簽到時間</th>
                <th style="white-space:nowrap;">簽退日期</th>
                <th style="white-space:nowrap;">簽退時間</th>
                <th style="white-space:nowrap;" class="text-end">時數(小時)</th>
              </tr>
            </thead>
            <tbody id="signTbody">
              <tr><td colspan="6" class="text-center text-muted py-3">載入中...</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

  <!-- 1) 開啟頁面先選人 Modal（✅ 顯示單位 + 職稱 + 姓名） -->
  <div class="modal fade" id="pickPersonModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-user-check me-2"></i>選擇使用者
          </h5>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">單位</label>
            <input class="form-control" id="pickUnit" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
          </div>

          <div class="mb-3">
            <label class="form-label">職稱</label>
            <input class="form-control" id="pickTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
          </div>

          <div class="mb-2">
            <label class="form-label">姓名</label>
            <select class="form-select" id="pickPersonName"></select>
          </div>

          <div class="small text-muted">選擇後下次自動帶入。</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" id="btnPickCancel" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-primary" id="btnPickOk" type="button">
            <i class="fa-solid fa-check me-1"></i>確定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) 簽到 Modal（✅ 不顯示單位，只顯示職稱/姓名） -->
  <div class="modal fade" id="signInModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-right-to-bracket me-2"></i>簽到
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>

        <div class="modal-body">
          <div id="inStatusBar" class="mb-3"></div>

          <div class="mb-3">
            <span class="badge text-bg-secondary badgeRound" id="inGpsBadge">
              <i class="fa-solid fa-location-dot me-1"></i>GPS 尚未判斷
            </span>
          </div>

          <div class="mb-3">
            <label class="form-label">勤務類別</label>
            <select class="form-select" id="inDutyType">
              <option value="assist">協勤</option>
              <option value="training">常年訓練</option>
              <option value="work">公差勤務</option>
            </select>
            <div class="form-text">
              協勤/常年訓練：需要通過 GPS；公差勤務：不需 GPS。
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">職稱</label>
              <input class="form-control" id="inTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
            </div>
            <div class="col-6">
              <label class="form-label">姓名</label>
              <select class="form-select" id="inPersonName"></select>
            </div>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">簽到日期</label>
              <input class="form-control" id="inDate" type="date">
            </div>
            <div class="col-6">
              <label class="form-label">簽到時間</label>
              <input class="form-control" id="inTime" type="time" step="60">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-success" id="btnSubmitSignIn" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>送出
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) 簽退 Modal（✅ 不顯示單位，只顯示職稱/姓名） -->
  <div class="modal fade" id="signOutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-right-from-bracket me-2"></i>簽退
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>

        <div class="modal-body">
          <div id="outStatusBar" class="mb-3"></div>

          <div class="mb-3">
            <span class="badge text-bg-secondary badgeRound" id="outGpsBadge">
              <i class="fa-solid fa-location-dot me-1"></i>GPS 尚未判斷
            </span>
          </div>

          <div class="mb-3">
            <label class="form-label">勤務類別</label>
            <select class="form-select" id="outDutyType">
              <option value="assist">協勤</option>
              <option value="work">公差勤務</option>
            </select>
            <div class="form-text">
              協勤：需要通過 GPS後選擇「出勤/備勤」；公差勤務：不需 GPS。
            </div>
          </div>

          <div class="mb-3" id="outModeWrap" style="display:none;">
            <label class="form-label">狀態</label>
            <select class="form-select" id="outMode">
              <option value="standby">備勤</option>
              <option value="dispatch">出勤</option>
            </select>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">職稱</label>
              <input class="form-control" id="outTitle" type="text" value="" readonly disabled tabindex="-1" aria-readonly="true">
            </div>
            <div class="col-6">
              <label class="form-label">姓名</label>
              <select class="form-select" id="outPersonName"></select>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">簽退日期</label>
              <input class="form-control" id="outDate" type="date">
            </div>
            <div class="col-6">
              <label class="form-label">簽退時間</label>
              <input class="form-control" id="outTime" type="time" step="60">
            </div>
          </div>

          <div class="mb-3" id="outContentWrap" style="display:none;">
            <label class="form-label">工作內容</label>
            <textarea class="form-control" id="outContent" rows="2" placeholder="例如：參加幹部會議 或 0800車禍高雄市新興區文化路29號"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-warning" id="btnSubmitSignOut" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>送出
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ 4) 送出確認 Modal（簽到/簽退共用；✅ 不顯示單位） -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content roundedX">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-circle-question me-2"></i>確認送出
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close" type="button"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning roundedX py-2 px-3">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>請確認資料無誤後再送出
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <tbody>
                <tr>
                  <th style="white-space:nowrap;width:110px;">類型</th>
                  <td id="cfType">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">職稱</th>
                  <td id="cfTitle">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">姓名</th>
                  <td id="cfPersonName">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">日期</th>
                  <td id="cfDate">--</td>
                </tr>
                <tr>
                  <th style="white-space:nowrap;">時間</th>
                  <td id="cfTime">--</td>
                </tr>
                <tr id="cfContentRow" style="display:none;">
                  <th style="white-space:nowrap;">內容</th>
                  <td id="cfContent">--</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            <i class="fa-solid fa-xmark me-1"></i>取消
          </button>
          <button class="btn btn-primary" id="btnConfirmSubmit" type="button">
            <i class="fa-solid fa-paper-plane me-1"></i>確定送出
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  const webAppUrl = "https://script.google.com/macros/s/AKfycbxoUGfQVQC_iDy1R--Ve9inpHTxz85daqU1HOU2ZTEIggw-A7JcqqjW4GKu3Py2khZV/exec";

  const gpsRules = {
    assist: [
      { name: "新興分隊", lat: 22.630760865622978, lng: 120.31122281518338, radius: 200 }
    ],
    training: [
      { name: "新興分隊", lat: 22.630760865622978, lng: 120.31122281518338, radius: 200 },
      { name: "日月光K11", lat: 22.722363004033074, lng: 120.30469365772642, radius: 100 }
    ]
  };

  // ✅ localStorage：v2（單位/職稱/姓名）+ 相容 v1（unitTitle/personName）
  const LS_KEY_V2 = "xh_ems_person_v2"; // { unit, title, name }
  const LS_KEY_V1 = "xh_ems_person_v1"; // 舊版：{ unitTitle, personName }

  let people = []; // [{ unit, title, name }]
  let selected = { unit: "", title: "", name: "" };
  let lastGps = { ok:false, lat:null, lng:null, accuracy:null };

  let pickModal, inModal, outModal, confirmModal;

  // ✅ 確認送出用（暫存一次送出的資料與動作）
  let pendingConfirm = {
    kind: "",          // "signIn" | "signOut"
    summary: null,     // { typeText, title, name, date, time, content? }
    request: null      // { action, ... } 要送到 GAS 的參數
  };

  $(function(){
    pickModal = new bootstrap.Modal(document.getElementById("pickPersonModal"));
    inModal = new bootstrap.Modal(document.getElementById("signInModal"));
    outModal = new bootstrap.Modal(document.getElementById("signOutModal"));
    confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));

    registerServiceWorker_();
    startClock_();
    bindEvents_();

    showLoading_(true);

    loadPeople_().then(function(){
      loadSelectedFromStorage_();

      if (!isSelectedValid_()) {
        openPickModal_();
      } else {
        applySelectedToUi_();
      }

      setDefaultMonth_();
      return refreshSignAsync_();
    }).always(function(){
      showLoading_(false);
      locate_();
    });
  });

  function bindEvents_(){
    $("#btnRelocate").on("click", locate_);

    $("#btnSwitchPerson").on("click", function(){
      openPickModal_();
    });

    // ✅ 選人：改姓名 -> 單位/職稱跟著變
    $("#pickPersonName").on("change", function(){
      const name = $(this).val();
      setPickInfoByName_(name);
    });

    // ✅ 簽到：改姓名 -> 職稱跟著變（不帶單位）
    $("#inPersonName").on("change", function(){
      const name = $(this).val();
      setTitleByName_(name, "#inTitle");
    });

    // ✅ 簽退：改姓名 -> 職稱跟著變（不帶單位）
    $("#outPersonName").on("change", function(){
      const name = $(this).val();
      setTitleByName_(name, "#outTitle");
    });

    $("#btnPickCancel").on("click", function(){
      if (!isSelectedValid_()) return;
      pickModal.hide();
    });

    $("#btnPickOk").on("click", function(){
      const name = $("#pickPersonName").val();
      const p = findPersonByName_(name);
      if (!p) { showStatus_("danger", "請先選擇姓名"); return; }

      selected.unit = p.unit || "";
      selected.title = p.title || "";
      selected.name = p.name || "";
      saveSelectedToStorage_();
      applySelectedToUi_();
      pickModal.hide();

      showLoading_(true);
      refreshSignAsync_().always(function(){ showLoading_(false); });
    });

    $("#btnOpenSignIn").on("click", function(){
      clearSignStatus_("in");
      fillSignInModal_();
      updateGpsBadgeForModal_("in");
      inModal.show();
    });

    $("#btnOpenSignOut").on("click", function(){
      clearSignStatus_("out");
      fillSignOutModal_();
      updateOutUiByDuty_();
      updateGpsBadgeForModal_("out");
      outModal.show();
    });

    $("#inDutyType").on("change", function(){
      updateGpsBadgeForModal_("in");
    });

    $("#outDutyType").on("change", function(){
      updateOutUiByDuty_();
      updateGpsBadgeForModal_("out");
    });

    $("#outMode").on("change", function(){
      updateOutUiByDuty_();
    });

    // ✅ 送出先開確認視窗
    $("#btnSubmitSignIn").on("click", prepareConfirmSignIn_);
    $("#btnSubmitSignOut").on("click", prepareConfirmSignOut_);
    $("#btnConfirmSubmit").on("click", doConfirmedSubmit_);

    $("#btnRefreshSign").on("click", function(){
      showLoading_(true);
      refreshSignAsync_().always(function(){ showLoading_(false); });
    });

    $("#signYmPicker").on("change", function(){
      showLoading_(true);
      refreshSignAsync_().always(function(){ showLoading_(false); });
    });
  }

  function showLoading_(show){
    if (show) $("#pageLoading").show();
    else $("#pageLoading").hide();
  }

  function findPersonByName_(name){
    const n = String(name || "").trim();
    if (!n) return null;
    return people.find(x => x && x.name === n) || null;
  }

  function setTitleByName_(name, titleSelector){
    const p = findPersonByName_(name);
    $(titleSelector).val(p ? (p.title || "") : "");
  }

  function setPickInfoByName_(name){
    const p = findPersonByName_(name);
    $("#pickUnit").val(p ? (p.unit || "") : "");
    $("#pickTitle").val(p ? (p.title || "") : "");
  }

  function startClock_(){
    tick_();
    setInterval(tick_, 1000);
  }

  function tick_(){
    const now = new Date();
    $("#nowDateText").text(fmtDate_(now));
    $("#nowClockText").text(fmtClockHms_(now));
  }

  // ---------- People / selected ----------
  function loadPeople_(){
    showStatus_("info", "載入名單中...");
    return $.get(webAppUrl, { action:"people" })
      .then(function(res){
        if (!res || !res.ok) throw new Error((res && res.message) ? res.message : "名單載入失敗");

        people = (res.data || []).map(x => ({
          unit: String(x.unit || "").trim(),
          title: String(x.title || "").trim(),
          name: String(x.name || "").trim()
        })).filter(x => x.name);

        if (!people.length) showStatus_("warning", "people 無資料");
        else showStatus_("success", "名單載入完成");

        buildPeopleSelects_();
      })
      .catch(function(err){
        showStatus_("danger", "名單載入失敗：" + (err && err.message ? err.message : err));
      });
  }

  function buildPeopleSelects_(){
    const opts = [];
    for (let i=0;i<people.length;i++){
      const p = people[i];
      opts.push(`<option value="${esc_(p.name)}">${esc_(p.name)}</option>`);
    }
    const html = opts.join("") || `<option value="">無資料</option>`;

    $("#pickPersonName").html(html);
    $("#inPersonName").html(html);
    $("#outPersonName").html(html);
  }

  // ✅ v2 + v1 相容搬移
  function loadSelectedFromStorage_(){
    // 先讀 v2
    try {
      const raw2 = localStorage.getItem(LS_KEY_V2);
      if (raw2) {
        const obj2 = JSON.parse(raw2);
        selected.unit = String(obj2.unit || "");
        selected.title = String(obj2.title || "");
        selected.name = String(obj2.name || "");
        return;
      }
    } catch { }

    // 再讀 v1（舊版），並自動搬移到 v2
    try {
      const raw1 = localStorage.getItem(LS_KEY_V1);
      if (!raw1) return;
      const obj1 = JSON.parse(raw1);

      const oldTitle = String(obj1.unitTitle || "");   // 舊版其實是「職稱」
      const oldName = String(obj1.personName || "");

      selected.unit = "";         // v1 沒有單位
      selected.title = oldTitle;
      selected.name = oldName;

      saveSelectedToStorage_();
      // localStorage.removeItem(LS_KEY_V1);
    } catch { }
  }

  function saveSelectedToStorage_(){
    try {
      localStorage.setItem(LS_KEY_V2, JSON.stringify({
        unit: selected.unit || "",
        title: selected.title || "",
        name: selected.name || ""
      }));
    } catch { }
  }

  function isSelectedValid_(){
    if (!selected.name) return false;
    return people.some(p => p.name === selected.name);
  }

  function applySelectedToUi_(){
    $("#navUnit").text(selected.unit || "--");
    $("#navTitle").text(selected.title || "--");
    $("#navPersonName").text(selected.name || "--");
  }

  function openPickModal_(){
    if (isSelectedValid_()){
      $("#pickPersonName").val(selected.name);
      setPickInfoByName_(selected.name);
    } else {
      const first = people[0];
      $("#pickPersonName").val(first ? first.name : "");
      setPickInfoByName_(first ? first.name : "");
    }
    pickModal.show();
  }

  // ---------- GPS ----------
  function locate_(){
    if (!("geolocation" in navigator)) {
      setGpsUi_("secondary", "不支援定位", null);
      showStatus_("danger", "此瀏覽器不支援定位功能");
      return;
    }

    setGpsUi_("secondary", "定位中...", null);

    navigator.geolocation.getCurrentPosition(
      function(pos){
        lastGps.ok = true;
        lastGps.lat = pos.coords.latitude;
        lastGps.lng = pos.coords.longitude;
        lastGps.accuracy = Math.round(pos.coords.accuracy || 0);

        $("#gpsRawText").text(`使用者定位：lat=${lastGps.lat}, lng=${lastGps.lng}`);
        setGpsUi_("success", "定位成功", `精度約 ${lastGps.accuracy} 公尺`);
        updateGpsBadgeForModal_("in");
        updateGpsBadgeForModal_("out");
      },
      function(err){
        lastGps.ok = false;
        lastGps.lat = null;
        lastGps.lng = null;
        lastGps.accuracy = null;

        $("#gpsRawText").text("使用者定位：lat=--, lng=--");
        setGpsUi_("danger", "GPS連線失敗", (err && err.message) ? err.message : "GPS連線失敗");
        showStatus_("danger", "GPS連線失敗，請確認定位權限或 GPS 設定");
      },
      { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
    );
  }

  function setGpsUi_(bsType, text, info){
    $("#gpsBadge")
      .removeClass("text-bg-secondary text-bg-success text-bg-danger text-bg-warning")
      .addClass("text-bg-" + bsType)
      .html(`<i class="fa-solid fa-location-dot me-1"></i>${esc_(text)}`);

    if (info) showStatus_("info", info);
  }

  function needGps_(dutyType){
    return dutyType === "assist" || dutyType === "training";
  }

  function gpsPass_(dutyType){
    if (!needGps_(dutyType)) return { pass:true, msg:"不需比對 GPS" };
    if (!lastGps.ok) return { pass:false, msg:"尚未GPS連線" };

    const rules = (dutyType === "training") ? gpsRules.training : gpsRules.assist;

    let passAny = false;
    for (let i=0;i<rules.length;i++){
      const t = rules[i];
      const d = Math.round(distMeters_(lastGps.lat, lastGps.lng, t.lat, t.lng));
      if (d <= (t.radius || 0)) passAny = true;
    }
    return { pass: passAny, msg: passAny ? "定位於範圍內" : "定位於範圍外" };
  }

  function updateGpsBadgeForModal_(which){
    const duty = (which === "in") ? $("#inDutyType").val() : $("#outDutyType").val();
    const r = gpsPass_(duty);

    const $b = (which === "in") ? $("#inGpsBadge") : $("#outGpsBadge");
    $b.removeClass("text-bg-secondary text-bg-success text-bg-danger")
      .addClass("text-bg-" + (r.pass ? "success" : "danger"))
      .html(`<i class="fa-solid fa-location-dot me-1"></i>${esc_(r.msg)}`);
  }

  // ---------- Sign list ----------
  function setDefaultMonth_(){
    const now = new Date();
    const ym = fmtYearMonth_(now);
    $("#signYmPicker").val(ym);
    $("#signYmText").text(ym);
  }

  function setAssistHoursUi_(allMinutes, monthMinutes, ym){
    const allH = minutesToHours1_(allMinutes);
    const monH = minutesToHours1_(monthMinutes);

    $("#totalAssistHoursText").text(allH.text);
    $("#monthAssistHoursText").text(monH.text);

    $("#totalAssistHint").text(allH.hint);
    $("#monthAssistHint").text(`${esc_(String(ym || ""))}｜${monH.hint}`);
  }

  function minutesToHours1_(m){
    const n = parseInt(String(m == null ? "" : m), 10);
    if (isNaN(n) || n <= 0) return { text: "0.0", hint: "0 分鐘" };

    const h = n / 60;
    const h1 = Math.round(h * 10) / 10;
    return { text: h1.toFixed(1), hint: `${n} 分鐘` };
  }

  function refreshSignAsync_(){
    const ym = $("#signYmPicker").val() || fmtYearMonth_(new Date());
    $("#signYmText").text(ym);

    $("#signTbody").html(`<tr><td colspan="6" class="text-center text-muted py-3">載入中...</td></tr>`);

    // ✅ 依「目前選擇者」過濾出勤清單，並回傳協勤累積/本月分鐘
    return $.get(webAppUrl, { action:"sign", ym: ym, personName: (selected.name || "") })
      .done(function(res){
        if (!res || !res.ok) {
          const msg = (res && res.message) ? res.message : "載入失敗";
          $("#signTbody").html(`<tr><td colspan="6" class="text-center text-danger py-3">${esc_(msg)}</td></tr>`);
          setAssistHoursUi_(0, 0, ym);
          return;
        }

        setAssistHoursUi_(res.totalAssistMinutesAll || 0, res.totalAssistMinutesMonth || 0, ym);

        const list = res.data || [];
        if (!list.length) {
          $("#signTbody").html(`<tr><td colspan="6" class="text-center text-muted py-3">無資料</td></tr>`);
          return;
        }

        const rows = [];
        for (let i=0;i<list.length;i++){
          const r = list[i];
          const mins = parseInt(String(r.minutes == null ? "" : r.minutes), 10);
          const hourText = (!isNaN(mins) && mins > 0) ? (Math.round((mins/60)*10)/10).toFixed(1) : "";

          rows.push(`
            <tr>
              <td>${esc_(r.dutyTypeText || "")}</td>
              <td>${esc_(r.signInDate || "")}</td>
              <td>${esc_(toHm_(r.signInTime || ""))}</td>
              <td>${esc_(r.signOutDate || "")}</td>
              <td>${esc_(toHm_(r.signOutTime || ""))}</td>
              <td class="text-end">${esc_(hourText)}</td>
            </tr>
          `);
        }
        $("#signTbody").html(rows.join(""));
      })
      .fail(function(){
        $("#signTbody").html(`<tr><td colspan="6" class="text-center text-danger py-3">載入失敗（請確認 GAS 部署/權限）</td></tr>`);
        setAssistHoursUi_(0, 0, ym);
      });
  }

  // ---------- SignIn / SignOut ----------
  function fillSignInModal_(){
    const now = new Date();

    $("#inPersonName").val(selected.name || "");
    setTitleByName_($("#inPersonName").val(), "#inTitle");

    $("#inDate").val(fmtDate_(now));
    $("#inTime").val(fmtClockHm_(now));

    if (!$("#inDutyType").val()) $("#inDutyType").val("assist");
  }

  function fillSignOutModal_(){
    const now = new Date();

    $("#outPersonName").val(selected.name || "");
    setTitleByName_($("#outPersonName").val(), "#outTitle");

    $("#outDate").val(fmtDate_(now));
    $("#outTime").val(fmtClockHm_(now));

    if (!$("#outDutyType").val()) $("#outDutyType").val("assist");
  }

  function updateOutUiByDuty_(){
    const duty = $("#outDutyType").val();
    const mode = $("#outMode").val();

    if (duty === "assist") {
      $("#outModeWrap").show();
      $("#outContentWrap").toggle(mode === "dispatch");
      if (mode !== "dispatch") $("#outContent").val("");
      return;
    }

    $("#outModeWrap").hide();
    $("#outMode").val("standby");
    $("#outContentWrap").show();
  }

  function dutyTypeText_(dutyType){
    if (dutyType === "assist") return "協勤";
    if (dutyType === "training") return "常年訓練";
    if (dutyType === "work") return "公差勤務";
    return String(dutyType || "");
  }

  function prepareConfirmSignIn_(){
    clearSignStatus_("in");

    const dutyType = $("#inDutyType").val();
    const title = $("#inTitle").val().trim();
    const name = $("#inPersonName").val().trim();
    const signInDate = $("#inDate").val();
    const signInTime = toHm_($("#inTime").val());

    if (!name) { showSignStatus_("in", "danger", "請選姓名"); return; }
    if (!signInDate || !signInTime) { showSignStatus_("in", "danger", "簽到日期／時間為必填"); return; }

    const gps = gpsPass_(dutyType);
    if (!gps.pass && needGps_(dutyType)) { showSignStatus_("in", "danger", "GPS 未通過，無法簽到"); return; }

    pendingConfirm.kind = "signIn";
    pendingConfirm.summary = {
      typeText: dutyTypeText_(dutyType),
      title: title,
      name: name,
      date: signInDate,
      time: signInTime,
      content: ""
    };
    pendingConfirm.request = {
      action:"signIn",
      dutyType: dutyType,
      title: title,
      personName: name,
      signInDate: signInDate,
      signInTime: signInTime
    };

    fillConfirmModal_(pendingConfirm.summary, false);
    confirmModal.show();
  }

  function prepareConfirmSignOut_(){
    clearSignStatus_("out");

    const dutyType = $("#outDutyType").val();
    const title = $("#outTitle").val().trim();
    const name = $("#outPersonName").val().trim();
    const signOutDate = $("#outDate").val();
    const signOutTime = toHm_($("#outTime").val());
    const mode = $("#outMode").val();
    const content = $("#outContent").val().trim();

    if (!name) { showSignStatus_("out", "danger", "請選姓名"); return; }
    if (!signOutDate || !signOutTime) { showSignStatus_("out", "danger", "簽退日期／時間為必填"); return; }

    const gps = gpsPass_(dutyType);
    if (!gps.pass && needGps_(dutyType)) { showSignStatus_("out", "danger", "GPS 未通過，無法簽退"); return; }

    let dutyContent = "";
    if (dutyType === "assist") {
      if (mode === "standby") {
        dutyContent = "協勤";
      } else {
        if (!content) { showSignStatus_("out", "danger", "協勤「出勤」請填工作內容"); return; }
        dutyContent = content;
      }
    } else {
      if (!content) { showSignStatus_("out", "danger", "公差勤務請填工作內容"); return; }
      dutyContent = content;
    }

    pendingConfirm.kind = "signOut";
    pendingConfirm.summary = {
      typeText: dutyTypeText_(dutyType),
      title: title,
      name: name,
      date: signOutDate,
      time: signOutTime,
      content: dutyContent
    };
    pendingConfirm.request = {
      action:"signOut",
      dutyType: dutyType,
      title: title,
      personName: name,
      signOutDate: signOutDate,
      signOutTime: signOutTime,
      dutyContent: dutyContent
    };

    fillConfirmModal_(pendingConfirm.summary, true);
    confirmModal.show();
  }

  function fillConfirmModal_(s, showContent){
    $("#cfType").text(s.typeText || "--");
    $("#cfTitle").text(s.title || "--");
    $("#cfPersonName").text(s.name || "--");
    $("#cfDate").text(s.date || "--");
    $("#cfTime").text(s.time || "--");

    if (showContent) {
      $("#cfContentRow").show();
      $("#cfContent").text(s.content || "--");
    } else {
      $("#cfContentRow").hide();
      $("#cfContent").text("");
    }
  }

  function doConfirmedSubmit_(){
    if (!pendingConfirm || !pendingConfirm.request || !pendingConfirm.request.action) {
      confirmModal.hide();
      return;
    }

    $("#btnConfirmSubmit").prop("disabled", true);
    showLoading_(true);

    const req = pendingConfirm.request;
    const kind = pendingConfirm.kind;

    $.get(webAppUrl, req)
      .done(function(res){
        if (res && res.ok) {
          if (kind === "signIn") {
            showSignStatus_("in", "success", "簽到完成");
            inModal.hide();
          } else {
            showSignStatus_("out", "success", "簽退完成");
            outModal.hide();
          }

          confirmModal.hide();
          refreshSignAsync_();
        } else {
          const msg = (res && res.message) ? res.message : "原因不明";
          if (kind === "signIn") showSignStatus_("in", "danger", "簽到失敗：" + msg);
          else showSignStatus_("out", "danger", "簽退失敗：" + msg);
        }
      })
      .fail(function(){
        if (kind === "signIn") showSignStatus_("in", "danger", "簽到送出失敗（請確認 GAS 部署／權限）");
        else showSignStatus_("out", "danger", "簽退送出失敗（請確認 GAS 部署／權限）");
      })
      .always(function(){
        showLoading_(false);
        $("#btnConfirmSubmit").prop("disabled", false);

        pendingConfirm.kind = "";
        pendingConfirm.summary = null;
        pendingConfirm.request = null;
      });
  }

  // ---------- status / utils ----------
  function showStatus_(type, msg){
    $("#statusBar").html(`
      <div class="alert alert-${esc_(type)} roundedX py-2 px-3 mb-0">
        <i class="fa-solid ${typeIcon_(type)} me-2"></i>${esc_(msg)}
      </div>
    `);
  }

  function clearSignStatus_(which){
    const $wrap = (which === "in") ? $("#inStatusBar") : $("#outStatusBar");
    $wrap.html("");
  }

  function showSignStatus_(which, type, msg){
    const $wrap = (which === "in") ? $("#inStatusBar") : $("#outStatusBar");
    $wrap.html(`
      <div class="alert alert-${esc_(type)} roundedX py-2 px-3 mb-0">
        <i class="fa-solid ${typeIcon_(type)} me-2"></i>${esc_(msg)}
      </div>
    `);
  }

  function typeIcon_(type){
    if (type === "success") return "fa-circle-check";
    if (type === "danger") return "fa-triangle-exclamation";
    if (type === "warning") return "fa-circle-exclamation";
    return "fa-circle-info";
  }

  function fmtDate_(d){
    const y = d.getFullYear();
    const m = pad2_(d.getMonth()+1);
    const day = pad2_(d.getDate());
    return `${y}-${m}-${day}`;
  }

  function fmtYearMonth_(d){
    const y = d.getFullYear();
    const m = pad2_(d.getMonth()+1);
    return `${y}-${m}`;
  }

  function fmtClockHms_(d){
    const hh = pad2_(d.getHours());
    const mm = pad2_(d.getMinutes());
    const ss = pad2_(d.getSeconds());
    return `${hh}:${mm}:${ss}`;
  }

  function fmtClockHm_(d){
    const hh = pad2_(d.getHours());
    const mm = pad2_(d.getMinutes());
    return `${hh}:${mm}`;
  }

  function toHm_(s){
    const t = String(s || "").trim();
    if (!t) return "";
    if (t.length >= 5) return t.substring(0, 5);
    return t;
  }

  function pad2_(n){ return (n<10 ? "0" : "") + n; }

  function esc_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function distMeters_(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);

    const a =
      Math.sin(dLat/2)*Math.sin(dLat/2) +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
      Math.sin(dLng/2)*Math.sin(dLng/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function registerServiceWorker_(){
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  }
</script>
</body>
</html>
